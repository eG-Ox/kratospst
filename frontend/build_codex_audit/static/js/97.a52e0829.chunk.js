"use strict";(self.webpackChunksistema_inventario_frontend=self.webpackChunksistema_inventario_frontend||[]).push([[97],{97(e,a,t){t.r(a),t.d(a,{default:()=>_});var o=t(950),r=t(112),n=t(414);const i=e=>{let{title:a,onClose:t,children:o}=e;return(0,n.jsx)("div",{className:"modal-overlay",children:(0,n.jsxs)("div",{className:"modal-content ventas-modal",children:[(0,n.jsxs)("div",{className:"modal-header",children:[(0,n.jsx)("h2",{children:a}),(0,n.jsx)("button",{type:"button",className:"btn-icon",onClick:t,children:"X"})]}),(0,n.jsx)("div",{className:"modal-body",children:o})]})})},s=e=>{var a;let{venta:t,cargando:o,error:r,onClose:s}=e;return t?(0,n.jsx)(i,{title:"Detalle venta #".concat(t.id),onClose:s,children:o?(0,n.jsx)("div",{className:"empty-message",children:"Cargando detalle..."}):r?(0,n.jsx)("div",{className:"error-message",children:r}):(0,n.jsxs)("div",{className:"ventas-split",children:[(0,n.jsxs)("div",{className:"ventas-card",children:[(0,n.jsx)("h3",{children:"Productos"}),(0,n.jsx)("div",{className:"table-container",children:0===(t.productos||[]).length?(0,n.jsx)("div",{className:"empty-message",children:"Sin productos."}):(0,n.jsxs)("table",{className:"ventas-table compact",children:[(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{children:[(0,n.jsx)("th",{children:"Codigo"}),(0,n.jsx)("th",{children:"Descripcion"}),(0,n.jsx)("th",{children:"Cantidad"}),(0,n.jsx)("th",{children:"Precio venta"}),(0,n.jsx)("th",{children:"Subtotal"})]})}),(0,n.jsx)("tbody",{children:(t.productos||[]).map(e=>{const a=Number(e.cantidad||0)*Number(e.precioVenta||0);return(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{children:e.codigo}),(0,n.jsx)("td",{children:e.descripcion}),(0,n.jsx)("td",{children:e.cantidad}),(0,n.jsxs)("td",{children:["S/ ",Number(e.precioVenta||0).toFixed(2)]}),(0,n.jsxs)("td",{children:["S/ ",a.toFixed(2)]})]},e.id)})})]})})]}),(0,n.jsxs)("div",{className:"ventas-card",children:[(0,n.jsx)("h3",{children:"Requerimientos"}),(0,n.jsx)("div",{className:"table-container",children:0===(t.requerimientos||[]).length?(0,n.jsx)("div",{className:"empty-message",children:"Sin requerimientos."}):(0,n.jsxs)("table",{className:"ventas-table compact",children:[(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{children:[(0,n.jsx)("th",{children:"Codigo"}),(0,n.jsx)("th",{children:"Descripcion"}),(0,n.jsx)("th",{children:"Cantidad"}),(0,n.jsx)("th",{children:"Proveedor"}),(0,n.jsx)("th",{children:"Compra"})]})}),(0,n.jsx)("tbody",{children:(t.requerimientos||[]).map(e=>(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{children:e.codigo}),(0,n.jsx)("td",{children:e.descripcion}),(0,n.jsx)("td",{children:e.cantidad}),(0,n.jsx)("td",{children:e.proveedor||"-"}),(0,n.jsxs)("td",{children:["S/ ",Number(e.precioCompra||0).toFixed(2)]})]},e.id))})]})})]}),(0,n.jsxs)("div",{className:"ventas-card",children:[(0,n.jsx)("h3",{children:"Regalos"}),(0,n.jsx)("div",{className:"table-container",children:0===(t.regalos||[]).length?(0,n.jsx)("div",{className:"empty-message",children:"Sin regalos."}):(0,n.jsxs)("table",{className:"ventas-table compact",children:[(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{children:[(0,n.jsx)("th",{children:"Codigo"}),(0,n.jsx)("th",{children:"Descripcion"}),(0,n.jsx)("th",{children:"Cantidad"}),(0,n.jsx)("th",{children:"Precio compra"})]})}),(0,n.jsx)("tbody",{children:(t.regalos||[]).map(e=>(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{children:e.codigo}),(0,n.jsx)("td",{children:e.descripcion}),(0,n.jsx)("td",{children:e.cantidad}),(0,n.jsxs)("td",{children:["S/ ",Number(e.precioCompra||0).toFixed(2)]})]},e.id))})]})})]}),(0,n.jsxs)("div",{className:"ventas-card",children:[(0,n.jsx)("h3",{children:"Regalos (requerimiento)"}),(0,n.jsx)("div",{className:"table-container",children:0===(t.regaloRequerimientos||[]).length?(0,n.jsx)("div",{className:"empty-message",children:"Sin regalos a comprar."}):(0,n.jsxs)("table",{className:"ventas-table compact",children:[(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{children:[(0,n.jsx)("th",{children:"Codigo"}),(0,n.jsx)("th",{children:"Descripcion"}),(0,n.jsx)("th",{children:"Cantidad"}),(0,n.jsx)("th",{children:"Proveedor"}),(0,n.jsx)("th",{children:"Compra"})]})}),(0,n.jsx)("tbody",{children:(t.regaloRequerimientos||[]).map(e=>(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{children:e.codigo}),(0,n.jsx)("td",{children:e.descripcion}),(0,n.jsx)("td",{children:e.cantidad}),(0,n.jsx)("td",{children:e.proveedor||"-"}),(0,n.jsxs)("td",{children:["S/ ",Number(e.precioCompra||0).toFixed(2)]})]},e.id))})]})})]}),(0,n.jsxs)("div",{className:"ventas-card ventas-card--full",children:[(0,n.jsx)("h3",{children:"Observaciones"}),(0,n.jsx)("div",{className:"helper-text",children:null!==(a=t.notas)&&void 0!==a&&a.trim()?t.notas:"Sin observaciones."})]})]})}):null};var c=t(555);const d=()=>(new Date).toISOString().slice(0,10),l=()=>"".concat(Date.now(),"-").concat(Math.random().toString(36).slice(2,8)),u=e=>String(e||"").toUpperCase().replace(/[^A-Z0-9]/g,""),m=e=>{var a,t;if(!e)return"";const o=null!==(a=null!==(t=e.producto_id)&&void 0!==t?t:e.productoId)&&void 0!==a?a:null;if(o)return"PID:".concat(o);const r=u(e.codigo||e.descripcion);return r?"KEY:".concat(r):""},p=["SHALOM","MARVISUR","OLVA","OTROS","TIENDA"],h=["PENDIENTE","ENVIADO","CANCELADO","VISITA"],g=e=>{let{step:a}=e;return(0,n.jsxs)("div",{className:"ventas-steps",children:[(0,n.jsx)("div",{className:"ventas-step ".concat(1===a?"active":""),children:"1. Datos"}),(0,n.jsx)("div",{className:"ventas-step ".concat(2===a?"active":""),children:"2. Productos"}),(0,n.jsx)("div",{className:"ventas-step ".concat(3===a?"active":""),children:"3. Regalos / Obs"})]})},v=e=>{let{step:a,onBack:t,onNext:o,onSave:r,editId:i}=e;return(0,n.jsxs)("div",{className:"modal-footer",children:[(0,n.jsx)("button",{type:"button",className:"btn-secondary",onClick:t,disabled:1===a,children:"Anterior"}),a<3?(0,n.jsx)("button",{type:"button",className:"btn-primary",onClick:o,children:"Siguiente"}):(0,n.jsx)("button",{type:"button",className:"btn-primary",onClick:r,children:i?"Guardar cambios":"Registrar venta"})]})},x=e=>{let{formData:a,consultaMensaje:t,consultando:o,usuarioActual:r,agencias:i,estadosEnvio:s,onConsultarDocumento:c,onFormChange:l}=e;return(0,n.jsxs)("div",{className:"ventas-step-panel",children:[(0,n.jsxs)("div",{className:"form-row",children:[(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Documento (DNI/RUC)"}),(0,n.jsxs)("div",{className:"ventas-row",children:[(0,n.jsxs)("select",{value:a.documentoTipo,onChange:e=>l({documentoTipo:e.target.value}),children:[(0,n.jsx)("option",{value:"dni",children:"DNI"}),(0,n.jsx)("option",{value:"ruc",children:"RUC"})]}),(0,n.jsx)("input",{type:"text",value:a.documento,onChange:e=>l({documento:e.target.value.trim()})}),(0,n.jsx)("button",{type:"button",className:"btn-secondary",onClick:c,disabled:o,children:o?"Consultando":"Consultar"})]}),t&&(0,n.jsx)("span",{className:"helper-text",children:t})]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Cliente"}),(0,n.jsx)("input",{type:"text",value:a.clienteNombre,onChange:e=>l({clienteNombre:e.target.value})})]})]}),(0,n.jsxs)("div",{className:"form-row",children:[(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Telefono"}),(0,n.jsx)("input",{type:"text",value:a.clienteTelefono,onChange:e=>l({clienteTelefono:e.target.value})})]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Vendedor"}),(0,n.jsx)("input",{type:"text",value:(null===r||void 0===r?void 0:r.nombre)||"",readOnly:!0,placeholder:"Usuario logeado"})]})]}),(0,n.jsxs)("div",{className:"form-row",children:[(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Agencia"}),(0,n.jsx)("select",{value:a.agencia,onChange:e=>l({agencia:e.target.value}),children:i.map(e=>(0,n.jsx)("option",{value:e,children:e},e))})]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Destino"}),(0,n.jsx)("input",{type:"text",value:a.destino,disabled:"TIENDA"===a.agencia,onChange:e=>l({destino:e.target.value})})]})]}),"OTROS"===a.agencia&&(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Agencia (otros)"}),(0,n.jsx)("input",{type:"text",value:a.agenciaOtro,onChange:e=>l({agenciaOtro:e.target.value})})]}),(0,n.jsxs)("div",{className:"form-row",children:[(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Fecha de venta"}),(0,n.jsx)("input",{type:"date",value:a.fechaVenta,onChange:e=>l({fechaVenta:e.target.value})})]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Estado de envio"}),(0,n.jsx)("select",{value:a.estadoEnvio,onChange:e=>{const t=e.target.value,o=d();l({estadoEnvio:t,fechaDespacho:"ENVIADO"===t||"VISITA"===t?a.fechaDespacho||o:a.fechaDespacho,fechaCancelacion:"CANCELADO"===t?a.fechaCancelacion||o:a.fechaCancelacion,rastreoEstado:"CANCELADO"===t?"ENTREGADO":a.rastreoEstado})},children:s.map(e=>(0,n.jsx)("option",{value:e,children:e},e))})]})]}),(0,n.jsxs)("div",{className:"form-row",children:[(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Adelanto"}),(0,n.jsx)("input",{type:"number",value:a.adelanto,onChange:e=>l({adelanto:e.target.value})})]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"P. Venta (total)"}),(0,n.jsx)("input",{type:"number",value:a.pVenta,readOnly:!0})]})]})]})},b=e=>{let{tabProductos:a,tabProductosModo:t,tabReqModo:o,busquedaProducto:r,resultadosProducto:i,busquedaRequerimiento:s,resultadosRequerimiento:d,cargandoKits:l,errorKits:u,kitsDisponibles:m,productos:p,setProductos:h,requerimientos:g,setTabProductos:v,setTabProductosModo:x,setTabReqModo:b,setBusquedaProducto:j,setBusquedaRequerimiento:R,setResultadosRequerimiento:N,agregarProducto:f,agregarKitVenta:C,agregarRequerimiento:q,actualizarItem:y,quitarItem:k,setRequerimientos:A,setRequerimiento:E,requerimiento:S,sugerenciaRequerimiento:D,ajustarCantidadProductoStock:_}=e;return(0,n.jsxs)("div",{className:"ventas-step-panel",children:[(0,n.jsxs)("div",{className:"ventas-tab-buttons",children:[(0,n.jsx)("button",{type:"button",className:"ventas-tab ".concat("productos"===a?"active":""),onClick:()=>v("productos"),children:"Productos"}),(0,n.jsx)("button",{type:"button",className:"ventas-tab ".concat("requerimientos"===a?"active":""),onClick:()=>v("requerimientos"),children:"Requerimientos"})]}),"productos"===a&&(0,n.jsxs)("div",{className:"ventas-card",children:[(0,n.jsx)("h3",{children:"Productos"}),(0,n.jsxs)("div",{className:"ventas-subtabs",children:[(0,n.jsx)("button",{type:"button",className:"ventas-subtab ".concat("avanzada"===t?"active":""),onClick:()=>x("avanzada"),children:"Avanzada"}),(0,n.jsx)("button",{type:"button",className:"ventas-subtab ".concat("kits"===t?"active":""),onClick:()=>x("kits"),children:"Kits"})]}),"avanzada"===t?(0,n.jsxs)("div",{className:"busqueda-avanzada",children:[(0,n.jsx)("input",{type:"text",placeholder:"Buscar producto por codigo, descripcion o marca",value:r,onChange:e=>j(e.target.value)}),(0,n.jsx)("div",{className:"resultados",children:i.map(e=>(0,n.jsxs)("button",{type:"button",className:"resultado-item",onClick:()=>f(e),children:[e.codigo," - ",e.descripcion," (",e.marca,")"]},"".concat(e.id,"-").concat(e.codigo)))})]}):(0,n.jsxs)("div",{className:"busqueda-avanzada",children:[l&&(0,n.jsx)("div",{className:"helper-text",children:"Cargando kits..."}),u&&(0,n.jsx)("div",{className:"helper-text",children:u}),(0,n.jsxs)("div",{className:"resultados",children:[m.map(e=>(0,n.jsxs)("button",{type:"button",className:"resultado-item",onClick:()=>C(e),children:[e.nombre," (S/. ",Number(e.precio_total||0).toFixed(2),")"]},"kit-".concat(e.id))),!l&&!m.length&&!u&&(0,n.jsx)("div",{className:"helper-text",children:"No hay kits activos."})]})]}),(0,n.jsx)("div",{className:"table-container",children:0===p.length?(0,n.jsx)("div",{className:"empty-message",children:"No hay productos agregados."}):(0,n.jsxs)("table",{className:"ventas-table",children:[(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{children:[(0,n.jsx)("th",{children:"Codigo"}),(0,n.jsx)("th",{children:"Descripcion"}),(0,n.jsx)("th",{children:"Stock"}),(0,n.jsx)("th",{children:"Cantidad"}),(0,n.jsx)("th",{children:"Venta"}),(0,n.jsx)("th",{children:"Compra"}),(0,n.jsx)("th",{})]})}),(0,n.jsx)("tbody",{children:p.map(e=>(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{children:e.codigo}),(0,n.jsx)("td",{children:e.descripcion}),(0,n.jsx)("td",{children:null===e.stock?"-":e.stock}),(0,n.jsx)("td",{children:(0,n.jsx)("input",{type:"number",min:"1",value:e.cantidad,onChange:a=>_(e.id,a.target.value)})}),(0,n.jsx)("td",{children:(0,n.jsx)("input",{type:"number",value:e.precioVenta,onChange:a=>y(h,e.id,{precioVenta:Number(a.target.value||0)})})}),(0,n.jsx)("td",{children:(0,n.jsx)("input",{type:"number",value:e.precioCompra,onChange:a=>y(h,e.id,{precioCompra:Number(a.target.value||0)})})}),(0,n.jsx)("td",{children:(0,n.jsx)("button",{type:"button",className:"btn-delete",onClick:()=>k(h,e.id),children:"Quitar"})})]},e.id))})]})})]}),"requerimientos"===a&&(0,n.jsxs)("div",{className:"ventas-card",children:[(0,n.jsx)("h3",{children:"Requerimientos"}),(0,n.jsxs)("div",{className:"ventas-subtabs",children:[(0,n.jsx)("button",{type:"button",className:"ventas-subtab ".concat("avanzada"===o?"active":""),onClick:()=>b("avanzada"),children:"Avanzada"}),(0,n.jsx)("button",{type:"button",className:"ventas-subtab ".concat("kits"===o?"active":""),onClick:()=>b("kits"),children:"Kits"})]}),(0,n.jsxs)("div",{className:"requerimiento-box",children:["avanzada"===o?(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Buscar producto"}),(0,n.jsx)("input",{type:"text",placeholder:"Buscar por codigo, descripcion o marca",value:s,onChange:e=>R(e.target.value)}),(0,n.jsx)("div",{className:"resultados",children:d.map(e=>(0,n.jsxs)("button",{type:"button",className:"resultado-item",onClick:()=>{E(a=>(0,c.A)((0,c.A)({},a),{},{productoId:e.id,codigo:e.codigo||"",descripcion:e.descripcion||e.codigo||a.descripcion,marca:e.marca||"",precioCompra:a.precioCompra||e.precio_compra||""})),R(""),N([])},children:[e.codigo," - ",e.descripcion," (",e.marca,")"]},"req-".concat(e.id,"-").concat(e.codigo)))})]}):(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Seleccionar kit"}),(0,n.jsxs)("div",{className:"resultados",children:[m.map(e=>(0,n.jsxs)("button",{type:"button",className:"resultado-item",onClick:()=>C(e),children:[e.nombre," (S/. ",Number(e.precio_total||0).toFixed(2),")"]},"kit-req-".concat(e.id))),!l&&!m.length&&!u&&(0,n.jsx)("div",{className:"helper-text",children:"No hay kits activos."}),u&&(0,n.jsx)("div",{className:"helper-text",children:u})]})]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Producto"}),(0,n.jsx)("input",{type:"text",value:S.descripcion,onChange:e=>E(a=>(0,c.A)((0,c.A)({},a),{},{productoId:null,descripcion:e.target.value}))}),S.codigo&&(0,n.jsxs)("span",{className:"helper-text",children:["Codigo: ",S.codigo]})]}),D&&(0,n.jsxs)("div",{className:"helper-text",children:["Sugerencia: ",D.descripcion||D.codigo," /",D.proveedor?" ".concat(D.proveedor):""," / Compra S/ ",Number(D.precioCompra||0).toFixed(2)]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Proveedor"}),(0,n.jsx)("input",{type:"text",value:S.proveedor,onChange:e=>E(a=>(0,c.A)((0,c.A)({},a),{},{proveedor:e.target.value}))})]}),(0,n.jsxs)("div",{className:"form-row",children:[(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Cantidad"}),(0,n.jsx)("input",{type:"number",min:"1",value:S.cantidad,onChange:e=>E(a=>(0,c.A)((0,c.A)({},a),{},{cantidad:e.target.value}))})]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Precio compra"}),(0,n.jsx)("input",{type:"number",value:S.precioCompra,onChange:e=>E(a=>(0,c.A)((0,c.A)({},a),{},{precioCompra:e.target.value}))})]})]}),(0,n.jsx)("div",{className:"form-group form-group-actions",children:(0,n.jsx)("button",{type:"button",className:"btn-secondary",onClick:q,children:"Agregar requerimiento"})})]}),(0,n.jsx)("div",{className:"table-container",children:0===g.length?(0,n.jsx)("div",{className:"empty-message",children:"Sin requerimientos."}):(0,n.jsxs)("table",{className:"ventas-table",children:[(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{children:[(0,n.jsx)("th",{children:"Codigo"}),(0,n.jsx)("th",{children:"Descripcion"}),(0,n.jsx)("th",{children:"Proveedor"}),(0,n.jsx)("th",{children:"Cantidad"}),(0,n.jsx)("th",{children:"Compra"}),(0,n.jsx)("th",{children:"Venta"}),(0,n.jsx)("th",{})]})}),(0,n.jsx)("tbody",{children:g.map(e=>(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{children:e.codigo}),(0,n.jsx)("td",{children:e.descripcion}),(0,n.jsx)("td",{children:e.proveedor||e.marca}),(0,n.jsx)("td",{children:(0,n.jsx)("input",{type:"number",min:"1",value:e.cantidad,onChange:a=>y(A,e.id,{cantidad:Number(a.target.value||1)})})}),(0,n.jsx)("td",{children:(0,n.jsx)("input",{type:"number",value:e.precioCompra,onChange:a=>y(A,e.id,{precioCompra:Number(a.target.value||0)})})}),(0,n.jsx)("td",{children:(0,n.jsx)("input",{type:"number",value:e.precioVenta,onChange:a=>y(A,e.id,{precioVenta:Number(a.target.value||0)})})}),(0,n.jsx)("td",{children:(0,n.jsx)("button",{type:"button",className:"btn-delete",onClick:()=>k(A,e.id),children:"Quitar"})})]},e.id))})]})})]})]})},j=e=>{let{tabRegalosModo:a,setTabRegalosModo:t,busquedaRegalo:o,setBusquedaRegalo:r,resultadosRegalo:i,agregarRegalo:s,cargandoKits:d,errorKits:l,kitsDisponibles:u,agregarKitRegalo:m,regalos:p,setRegalos:h,tabReqRegaloModo:g,setTabReqRegaloModo:v,busquedaReqRegalo:x,setBusquedaReqRegalo:b,resultadosReqRegalo:j,setResultadosReqRegalo:R,setRegaloRequerimiento:N,regaloRequerimiento:f,sugerenciaRegalo:C,agregarRegaloRequerimiento:q,regaloRequerimientos:y,setRegaloRequerimientos:k,actualizarItem:A,quitarItem:E,formData:S,setFormData:D,ajustarCantidadRegaloStock:_}=e;return(0,n.jsx)("div",{className:"ventas-step-panel",children:(0,n.jsxs)("div",{className:"ventas-split",children:[(0,n.jsxs)("div",{className:"ventas-card",children:[(0,n.jsx)("h3",{children:"Regalos"}),(0,n.jsxs)("div",{className:"ventas-subtabs",children:[(0,n.jsx)("button",{type:"button",className:"ventas-subtab ".concat("avanzada"===a?"active":""),onClick:()=>t("avanzada"),children:"Avanzada"}),(0,n.jsx)("button",{type:"button",className:"ventas-subtab ".concat("kits"===a?"active":""),onClick:()=>t("kits"),children:"Kits"})]}),"avanzada"===a?(0,n.jsxs)("div",{className:"busqueda-avanzada",children:[(0,n.jsx)("input",{type:"text",placeholder:"Buscar regalo por codigo, descripcion o marca",value:o,onChange:e=>r(e.target.value)}),(0,n.jsx)("div",{className:"resultados",children:i.map(e=>(0,n.jsxs)("button",{type:"button",className:"resultado-item",onClick:()=>s(e),children:[e.codigo," - ",e.descripcion," (",e.marca,")"]},"gift-".concat(e.id,"-").concat(e.codigo)))})]}):(0,n.jsxs)("div",{className:"busqueda-avanzada",children:[d&&(0,n.jsx)("div",{className:"helper-text",children:"Cargando kits..."}),l&&(0,n.jsx)("div",{className:"helper-text",children:l}),(0,n.jsxs)("div",{className:"resultados",children:[u.map(e=>(0,n.jsxs)("button",{type:"button",className:"resultado-item",onClick:()=>m(e),children:[e.nombre," (S/. ",Number(e.precio_total||0).toFixed(2),")"]},"kit-gift-".concat(e.id))),!d&&!u.length&&!l&&(0,n.jsx)("div",{className:"helper-text",children:"No hay kits activos."})]})]}),(0,n.jsx)("div",{className:"table-container",children:0===p.length?(0,n.jsx)("div",{className:"empty-message",children:"No hay regalos agregados."}):(0,n.jsxs)("table",{className:"ventas-table",children:[(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{children:[(0,n.jsx)("th",{children:"Codigo"}),(0,n.jsx)("th",{children:"Descripcion"}),(0,n.jsx)("th",{children:"Stock"}),(0,n.jsx)("th",{children:"Cantidad"}),(0,n.jsx)("th",{children:"Compra"}),(0,n.jsx)("th",{})]})}),(0,n.jsx)("tbody",{children:p.map(e=>(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{children:e.codigo}),(0,n.jsx)("td",{children:e.descripcion}),(0,n.jsx)("td",{children:null===e.stock?"-":e.stock}),(0,n.jsx)("td",{children:(0,n.jsx)("input",{type:"number",min:"1",value:e.cantidad,onChange:a=>_(e.id,a.target.value)})}),(0,n.jsx)("td",{children:(0,n.jsx)("input",{type:"number",value:e.precioCompra,onChange:a=>A(h,e.id,{precioCompra:Number(a.target.value||0)})})}),(0,n.jsx)("td",{children:(0,n.jsx)("button",{type:"button",className:"btn-delete",onClick:()=>E(h,e.id),children:"Quitar"})})]},e.id))})]})})]}),(0,n.jsxs)("div",{className:"ventas-card",children:[(0,n.jsx)("h3",{children:"Requerimiento regalos"}),(0,n.jsxs)("div",{className:"ventas-subtabs",children:[(0,n.jsx)("button",{type:"button",className:"ventas-subtab ".concat("avanzada"===g?"active":""),onClick:()=>v("avanzada"),children:"Avanzada"}),(0,n.jsx)("button",{type:"button",className:"ventas-subtab ".concat("kits"===g?"active":""),onClick:()=>v("kits"),children:"Kits"})]}),(0,n.jsxs)("div",{className:"requerimiento-box",children:["avanzada"===g?(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Buscar producto"}),(0,n.jsx)("input",{type:"text",placeholder:"Buscar por codigo, descripcion o marca",value:x,onChange:e=>b(e.target.value)}),(0,n.jsx)("div",{className:"resultados",children:j.map(e=>(0,n.jsxs)("button",{type:"button",className:"resultado-item",onClick:()=>{N(a=>(0,c.A)((0,c.A)({},a),{},{productoId:e.id,codigo:e.codigo||"",descripcion:e.descripcion||e.codigo||a.descripcion,marca:e.marca||"",precioCompra:a.precioCompra||e.precio_compra||""})),b(""),R([])},children:[e.codigo," - ",e.descripcion," (",e.marca,")"]},"req-reg-".concat(e.id,"-").concat(e.codigo)))})]}):(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Seleccionar kit"}),(0,n.jsxs)("div",{className:"resultados",children:[u.map(e=>(0,n.jsxs)("button",{type:"button",className:"resultado-item",onClick:()=>m(e),children:[e.nombre," (S/. ",Number(e.precio_total||0).toFixed(2),")"]},"kit-req-reg-".concat(e.id))),!d&&!u.length&&!l&&(0,n.jsx)("div",{className:"helper-text",children:"No hay kits activos."}),l&&(0,n.jsx)("div",{className:"helper-text",children:l})]})]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Producto"}),(0,n.jsx)("input",{type:"text",value:f.descripcion,onChange:e=>N(a=>(0,c.A)((0,c.A)({},a),{},{productoId:null,descripcion:e.target.value}))}),f.codigo&&(0,n.jsxs)("span",{className:"helper-text",children:["Codigo: ",f.codigo]})]}),C&&(0,n.jsxs)("div",{className:"helper-text",children:["Sugerencia: ",C.descripcion||C.codigo," /",C.proveedor?" ".concat(C.proveedor):""," / Compra S/ ",Number(C.precioCompra||0).toFixed(2)]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Proveedor"}),(0,n.jsx)("input",{type:"text",value:f.proveedor,onChange:e=>N(a=>(0,c.A)((0,c.A)({},a),{},{proveedor:e.target.value}))})]}),(0,n.jsxs)("div",{className:"form-row",children:[(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Cantidad"}),(0,n.jsx)("input",{type:"number",min:"1",value:f.cantidad,onChange:e=>N(a=>(0,c.A)((0,c.A)({},a),{},{cantidad:e.target.value}))})]}),(0,n.jsxs)("div",{className:"form-group",children:[(0,n.jsx)("label",{children:"Precio compra"}),(0,n.jsx)("input",{type:"number",value:f.precioCompra,onChange:e=>N(a=>(0,c.A)((0,c.A)({},a),{},{precioCompra:e.target.value}))})]})]}),(0,n.jsx)("div",{className:"form-group form-group-actions",children:(0,n.jsx)("button",{type:"button",className:"btn-secondary",onClick:q,children:"Agregar requerimiento"})})]}),(0,n.jsx)("div",{className:"table-container",children:0===y.length?(0,n.jsx)("div",{className:"empty-message",children:"Sin requerimientos."}):(0,n.jsxs)("table",{className:"ventas-table",children:[(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{children:[(0,n.jsx)("th",{children:"Codigo"}),(0,n.jsx)("th",{children:"Descripcion"}),(0,n.jsx)("th",{children:"Proveedor"}),(0,n.jsx)("th",{children:"Cantidad"}),(0,n.jsx)("th",{children:"Compra"}),(0,n.jsx)("th",{})]})}),(0,n.jsx)("tbody",{children:y.map(e=>(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{children:e.codigo}),(0,n.jsx)("td",{children:e.descripcion}),(0,n.jsx)("td",{children:e.proveedor||e.marca}),(0,n.jsx)("td",{children:(0,n.jsx)("input",{type:"number",min:"1",value:e.cantidad,onChange:a=>A(k,e.id,{cantidad:Number(a.target.value||1)})})}),(0,n.jsx)("td",{children:(0,n.jsx)("input",{type:"number",value:e.precioCompra,onChange:a=>A(k,e.id,{precioCompra:Number(a.target.value||0)})})}),(0,n.jsx)("td",{children:(0,n.jsx)("button",{type:"button",className:"btn-delete",onClick:()=>E(k,e.id),children:"Quitar"})})]},e.id))})]})}),(0,n.jsxs)("div",{className:"ventas-notas",children:[(0,n.jsx)("label",{children:"Observaciones / notas"}),(0,n.jsx)("textarea",{value:S.notas,onChange:e=>D(a=>(0,c.A)((0,c.A)({},a),{},{notas:e.target.value}))})]})]})]})})},R=e=>{let{title:a,onClose:t,step:o,error:r,avisoStock:s,editId:c,onBack:d,onNext:l,onSave:u,formData:m,setFormData:p,consultaMensaje:h,consultando:R,usuarioActual:N,agencias:f,estadosEnvio:C,onConsultarDocumento:q,onFormChange:y,tabProductos:k,tabProductosModo:A,tabReqModo:E,busquedaProducto:S,resultadosProducto:D,busquedaRequerimiento:_,resultadosRequerimiento:P,cargandoKits:I,errorKits:M,kitsDisponibles:T,productos:V,setProductos:w,requerimientos:z,setTabProductos:O,setTabProductosModo:B,setTabReqModo:K,setBusquedaProducto:F,setBusquedaRequerimiento:L,setResultadosRequerimiento:H,agregarProducto:G,agregarKitVenta:X,agregarRequerimiento:U,actualizarItem:Q,quitarItem:$,setRequerimientos:J,setRequerimiento:Y,requerimiento:Z,sugerenciaRequerimiento:W,ajustarCantidadProductoStock:ee,tabRegalosModo:ae,setTabRegalosModo:te,busquedaRegalo:oe,setBusquedaRegalo:re,resultadosRegalo:ne,agregarRegalo:ie,agregarKitRegalo:se,regalos:ce,setRegalos:de,tabReqRegaloModo:le,setTabReqRegaloModo:ue,busquedaReqRegalo:me,setBusquedaReqRegalo:pe,resultadosReqRegalo:he,setResultadosReqRegalo:ge,setRegaloRequerimiento:ve,regaloRequerimiento:xe,sugerenciaRegalo:be,agregarRegaloRequerimiento:je,regaloRequerimientos:Re,setRegaloRequerimientos:Ne,ajustarCantidadRegaloStock:fe}=e;return(0,n.jsxs)(i,{title:a,onClose:t,children:[(0,n.jsx)(g,{step:o}),r&&(0,n.jsx)("div",{className:"error-message",children:r}),s&&(0,n.jsx)("div",{className:"helper-text",children:s}),1===o&&(0,n.jsx)(x,{formData:m,consultaMensaje:h,consultando:R,usuarioActual:N,agencias:f,estadosEnvio:C,onConsultarDocumento:q,onFormChange:y}),2===o&&(0,n.jsx)(b,{tabProductos:k,tabProductosModo:A,tabReqModo:E,busquedaProducto:S,resultadosProducto:D,busquedaRequerimiento:_,resultadosRequerimiento:P,cargandoKits:I,errorKits:M,kitsDisponibles:T,productos:V,setProductos:w,requerimientos:z,setTabProductos:O,setTabProductosModo:B,setTabReqModo:K,setBusquedaProducto:F,setBusquedaRequerimiento:L,setResultadosRequerimiento:H,agregarProducto:G,agregarKitVenta:X,agregarRequerimiento:U,actualizarItem:Q,quitarItem:$,setRequerimientos:J,setRequerimiento:Y,requerimiento:Z,sugerenciaRequerimiento:W,ajustarCantidadProductoStock:ee}),3===o&&(0,n.jsx)(j,{tabRegalosModo:ae,setTabRegalosModo:te,busquedaRegalo:oe,setBusquedaRegalo:re,resultadosRegalo:ne,agregarRegalo:ie,cargandoKits:I,errorKits:M,kitsDisponibles:T,agregarKitRegalo:se,regalos:ce,setRegalos:de,tabReqRegaloModo:le,setTabReqRegaloModo:ue,busquedaReqRegalo:me,setBusquedaReqRegalo:pe,resultadosReqRegalo:he,setResultadosReqRegalo:ge,setRegaloRequerimiento:ve,regaloRequerimiento:xe,sugerenciaRegalo:be,agregarRegaloRequerimiento:je,regaloRequerimientos:Re,setRegaloRequerimientos:Ne,actualizarItem:Q,quitarItem:$,formData:m,setFormData:p,ajustarCantidadRegaloStock:fe}),(0,n.jsx)(v,{step:o,onBack:d,onNext:l,onSave:u,editId:c})]})},N=e=>{let{ventasListado:a,usuariosVentas:t,estadosEnvio:o,ventasHasMore:r,ventasLoading:i,onCargarMas:s,onEstadoEnvioChange:c,onAbrirEdicion:d,onAbrirDetalle:l,onAbrirRotulo:u,onEliminar:m}=e;return(0,n.jsxs)("div",{className:"ventas-table-section",children:[(0,n.jsx)("div",{className:"table-container",children:0===a.length?(0,n.jsx)("div",{className:"empty-message",children:"No hay ventas registradas."}):(0,n.jsxs)("table",{className:"ventas-table compact",children:[(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{children:[(0,n.jsx)("th",{children:"Documento"}),(0,n.jsx)("th",{children:"Cliente"}),(0,n.jsx)("th",{children:"Telefono"}),(0,n.jsx)("th",{children:"Vendedor"}),(0,n.jsx)("th",{children:"Agencia"}),(0,n.jsx)("th",{children:"Destino"}),(0,n.jsx)("th",{children:"Fecha venta"}),(0,n.jsx)("th",{children:"Estado pedido"}),(0,n.jsx)("th",{children:"Estado envio"}),(0,n.jsx)("th",{children:"Fecha despacho"}),(0,n.jsx)("th",{children:"Fecha cancelacion"}),(0,n.jsx)("th",{children:"P. Venta"}),(0,n.jsx)("th",{children:"Adelanto"}),(0,n.jsx)("th",{})]})}),(0,n.jsx)("tbody",{children:a.map(e=>{const a=t.find(a=>String(a.id)===String(e.vendedorId)),r="OTROS"===e.agencia?"".concat(e.agencia," (").concat(e.agenciaOtro,")"):e.agencia;return(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{children:e.documento}),(0,n.jsx)("td",{children:e.clienteNombre||"-"}),(0,n.jsx)("td",{children:e.clienteTelefono||"-"}),(0,n.jsx)("td",{children:(null===a||void 0===a?void 0:a.nombre)||e.vendedorId}),(0,n.jsx)("td",{children:r}),(0,n.jsx)("td",{children:e.destino||"-"}),(0,n.jsx)("td",{children:e.fechaVenta||"-"}),(0,n.jsx)("td",{children:(0,n.jsx)("span",{className:"pedido-pill ".concat(String(e.estadoPedido||"PICKING").toLowerCase()),children:e.estadoPedido||"PICKING"})}),(0,n.jsx)("td",{children:(0,n.jsx)("select",{className:"estado-select ".concat((e.estadoEnvio||"pendiente").toLowerCase()),value:e.estadoEnvio||"PENDIENTE",onChange:a=>c(e,a.target.value),children:o.map(a=>(0,n.jsx)("option",{value:a,disabled:("ENVIADO"===a||"CANCELADO"===a)&&"PEDIDO_LISTO"!==(e.estadoPedido||"PICKING"),children:a},a))})}),(0,n.jsx)("td",{children:e.fechaDespacho||"-"}),(0,n.jsx)("td",{children:e.fechaCancelacion||"-"}),(0,n.jsxs)("td",{children:["S/ ",Number(e.pVenta||0).toFixed(2)]}),(0,n.jsx)("td",{children:e.adelanto||"-"}),(0,n.jsx)("td",{children:(0,n.jsxs)("div",{className:"venta-actions",children:[(0,n.jsx)("button",{type:"button",className:"icon-btn icon-btn--edit",onClick:()=>d(e),title:"Editar","aria-label":"Editar",children:(0,n.jsxs)("svg",{viewBox:"0 0 24 24","aria-hidden":"true",children:[(0,n.jsx)("path",{d:"M4 17.5V20h2.5L17.9 8.6l-2.5-2.5L4 17.5z"}),(0,n.jsx)("path",{d:"M20.7 7.2a1 1 0 0 0 0-1.4l-2.5-2.5a1 1 0 0 0-1.4 0l-1.7 1.7 2.5 2.5 1.7-1.7z"})]})}),(0,n.jsx)("button",{type:"button",className:"icon-btn icon-btn--view",onClick:()=>l(e),title:"Detalle","aria-label":"Detalle",children:(0,n.jsx)("svg",{viewBox:"0 0 24 24","aria-hidden":"true",children:(0,n.jsx)("path",{d:"M12 5c4.5 0 8.3 2.7 10 6.5C20.3 15.3 16.5 18 12 18S3.7 15.3 2 11.5C3.7 7.7 7.5 5 12 5zm0 2c-3.2 0-6 1.7-7.6 4.5C6 14.3 8.8 16 12 16s6-1.7 7.6-4.5C18 8.7 15.2 7 12 7zm0 2.5a2.5 2.5 0 1 1 0 5a2.5 2.5 0 0 1 0-5z"})})}),(0,n.jsx)("button",{type:"button",className:"icon-btn icon-btn--view",onClick:()=>u(e),title:"Rotulo","aria-label":"Rotulo",children:(0,n.jsx)("svg",{viewBox:"0 0 24 24","aria-hidden":"true",children:(0,n.jsx)("path",{d:"M4 4h9l7 8-7 8H4V4zm8.6 4.2L9 11.8l3.6 3.6 1.4-1.4-2.2-2.2 2.2-2.2-1.4-1.4z"})})}),(0,n.jsx)("button",{type:"button",className:"icon-btn icon-btn--delete",onClick:()=>m(e.id),title:"Eliminar","aria-label":"Eliminar",children:(0,n.jsxs)("svg",{viewBox:"0 0 24 24","aria-hidden":"true",children:[(0,n.jsx)("path",{d:"M6 7h12l-1 14H7L6 7z"}),(0,n.jsx)("path",{d:"M9 7V5h6v2h4v2H5V7h4z"})]})})]})})]},e.id)})})]})}),r&&(0,n.jsx)("div",{className:"table-actions",children:(0,n.jsx)("button",{type:"button",className:"btn-secondary",onClick:s,disabled:i,children:i?"Cargando...":"Cargar mas"})})]})},f=e=>!0===(null===e||void 0===e?void 0:e.detalleIncluido)||Array.isArray(null===e||void 0===e?void 0:e.productos)||Array.isArray(null===e||void 0===e?void 0:e.requerimientos)||Array.isArray(null===e||void 0===e?void 0:e.regalos)||Array.isArray(null===e||void 0===e?void 0:e.regaloRequerimientos),C=e=>{const[a,t]=(0,o.useState)(null),[n,i]=(0,o.useState)(!1),[s,c]=(0,o.useState)(""),d=(0,o.useCallback)(a=>{e&&e(a)},[e]),l=(0,o.useCallback)(async e=>{const a=(await r.XR.obtener(e)).data||null;return a&&d(a),a},[d]),u=(0,o.useCallback)(async e=>{if(e)if(c(""),t(e),f(e))i(!1);else{i(!0);try{const a=await l(e.id);a?t(a):c("No se pudo cargar el detalle de la venta.")}catch(a){console.error("Error cargando detalle de venta:",a),c("No se pudo cargar el detalle de la venta.")}finally{i(!1)}}},[l]),m=(0,o.useCallback)(()=>{t(null),i(!1),c("")},[]);return{detalleVenta:a,detalleCargando:n,detalleError:s,abrirDetalleVenta:u,obtenerVentaDetalle:l,resetDetalle:m,setDetalleVenta:t,ventaTieneDetalle:f}},q=()=>({documentoTipo:"dni",documento:"",clienteNombre:"",clienteTelefono:"",vendedorId:"",agencia:"SHALOM",agenciaOtro:"",destino:"",fechaVenta:d(),estadoEnvio:"PENDIENTE",fechaDespacho:"",fechaCancelacion:"",encargado:"",pVenta:0,adelanto:"",rastreoEstado:"EN TRANSITO",ticket:"",guia:"",retiro:"",notas:""}),y=()=>({productoId:null,codigo:"",descripcion:"",marca:"",proveedor:"",cantidad:1,precioCompra:""}),k=e=>{let{mountedRef:a,usuarioActual:t,cargarVentas:n,obtenerVentaDetalle:i,ventaTieneDetalle:s}=e;const[p,h]=(0,o.useState)(""),[g,v]=(0,o.useState)(!1),[x,b]=(0,o.useState)(""),[j,R]=(0,o.useState)(!1),[N,f]=(0,o.useState)(1),[C,k]=(0,o.useState)(""),[A,E]=(0,o.useState)(null),[S,D]=(0,o.useState)("productos"),[_,P]=(0,o.useState)(q),[I,M]=(0,o.useState)(""),[T,V]=(0,o.useState)([]),[w,z]=(0,o.useState)(""),[O,B]=(0,o.useState)([]),[K,F]=(0,o.useState)(""),[L,H]=(0,o.useState)([]),[G,X]=(0,o.useState)(""),[U,Q]=(0,o.useState)([]),[$,J]=(0,o.useState)("avanzada"),[Y,Z]=(0,o.useState)("avanzada"),[W,ee]=(0,o.useState)("avanzada"),[ae,te]=(0,o.useState)("avanzada"),[oe,re]=(0,o.useState)([]),[ne,ie]=(0,o.useState)(!1),[se,ce]=(0,o.useState)(""),[de,le]=(0,o.useState)([]),[ue,me]=(0,o.useState)([]),[pe,he]=(0,o.useState)([]),[ge,ve]=(0,o.useState)([]),[xe,be]=(0,o.useState)(y),[je,Re]=(0,o.useState)(y),[Ne,fe]=(0,o.useState)(null),[Ce,qe]=(0,o.useState)(null);(0,o.useEffect)(()=>{if(!j)return;let e=!0;return(async()=>{try{ie(!0),ce("");const t=await r.dx.listarActivos();if(!e||a&&!a.current)return;re(t.data||[])}catch(t){if(!e||a&&!a.current)return;console.error("Error cargando kits:",t),ce("No se pudieron cargar los kits.")}finally{!e||a&&!a.current||ie(!1)}})(),()=>{e=!1}},[j,a]),(0,o.useEffect)(()=>{"TIENDA"!==_.agencia?"TIENDA"===_.destino&&P(e=>(0,c.A)((0,c.A)({},e),{},{destino:""})):P(e=>(0,c.A)((0,c.A)({},e),{},{destino:"TIENDA"}))},[_.agencia,_.destino]);const ye=(0,o.useCallback)(async(e,t)=>{try{const o=await r.DI.buscarProductos({q:e,limit:20});if(a&&!a.current)return;t(o.data||[])}catch(o){console.error("Error buscando productos:",o)}},[a]);(0,o.useEffect)(()=>{const e=setTimeout(()=>{I.trim().length<1?V([]):ye(I.trim(),V)},350);return()=>clearTimeout(e)},[I,ye]),(0,o.useEffect)(()=>{const e=setTimeout(()=>{w.trim().length<1?B([]):ye(w.trim(),B)},350);return()=>clearTimeout(e)},[w,ye]),(0,o.useEffect)(()=>{const e=setTimeout(()=>{K.trim().length<1?H([]):ye(K.trim(),H)},350);return()=>clearTimeout(e)},[K,ye]),(0,o.useEffect)(()=>{const e=setTimeout(()=>{G.trim().length<1?Q([]):ye(G.trim(),Q)},350);return()=>clearTimeout(e)},[G,ye]),(0,o.useEffect)(()=>{const e=setTimeout(async()=>{const e=xe.descripcion.trim();if(e.length<2)fe(null);else try{var a;const t=null===(a=(await r.XR.historialRequerimientos({q:e})).data)||void 0===a?void 0:a[0];t&&(fe(t),be(e=>(0,c.A)((0,c.A)({},e),{},{proveedor:e.proveedor||t.proveedor||"",precioCompra:e.precioCompra||t.precioCompra||""})))}catch(t){console.error("Error buscando historial requerimientos:",t)}},400);return()=>clearTimeout(e)},[xe.descripcion]),(0,o.useEffect)(()=>{const e=setTimeout(async()=>{const e=je.descripcion.trim();if(e.length<2)qe(null);else try{var a;const t=null===(a=(await r.XR.historialRequerimientos({q:e})).data)||void 0===a?void 0:a[0];t&&(qe(t),Re(e=>(0,c.A)((0,c.A)({},e),{},{proveedor:e.proveedor||t.proveedor||"",precioCompra:e.precioCompra||t.precioCompra||""})))}catch(t){console.error("Error buscando historial regalos:",t)}},400);return()=>clearTimeout(e)},[je.descripcion]);const ke=e=>{var a,t,o,r;const n=null!==(a=null!==(t=null!==(o=null!==(r=e.stock)&&void 0!==r?r:e.stock_total)&&void 0!==o?o:e.stock_disponible)&&void 0!==t?t:e.cantidad)&&void 0!==a?a:null;return null===n?null:Number(n||0)},Ae=e=>({id:l(),tipo:"stock",producto_id:e.producto_id,codigo:e.codigo||"",descripcion:e.descripcion||"",marca:e.marca||"",stock:Number(e.stock||0),cantidad:Number(e.cantidad||1),precioVenta:Number(e.precio_final||e.precio_unitario||0),precioCompra:0,proveedor:""}),Ee=e=>({id:l(),tipo:"compra",producto_id:e.producto_id,codigo:e.codigo||"",descripcion:e.descripcion||"",marca:e.marca||"",stock:Number(e.stock||0),cantidad:Number(e.cantidad||1),precioVenta:Number(e.precio_final||e.precio_unitario||0),precioCompra:0,proveedor:""}),Se=e=>({id:l(),tipo:"stock",producto_id:e.producto_id,codigo:e.codigo||"",descripcion:e.descripcion||"",marca:e.marca||"",stock:Number(e.stock||0),cantidad:Number(e.cantidad||1),precioCompra:0,proveedor:""}),De=e=>({id:l(),tipo:"compra",producto_id:e.producto_id,codigo:e.codigo||"",descripcion:e.descripcion||"",marca:e.marca||"",stock:Number(e.stock||0),cantidad:Number(e.cantidad||1),precioCompra:0,proveedor:""}),_e=(0,o.useMemo)(()=>de.reduce((e,a)=>e+Number(a.precioVenta||0)*Number(a.cantidad||0),0),[de]);(0,o.useEffect)(()=>{P(e=>(0,c.A)((0,c.A)({},e),{},{pVenta:Number(_e||0)}))},[_e]);const Pe=()=>{P(q()),le([]),me([]),he([]),ve([]),be({productoId:null,codigo:"",descripcion:"",marca:"",proveedor:"",cantidad:1,precioCompra:""}),Re({productoId:null,codigo:"",descripcion:"",marca:"",proveedor:"",cantidad:1,precioCompra:""}),M(""),V([]),z(""),B([]),F(""),H([]),X(""),Q([]),fe(null),qe(null),h(""),k(""),b(""),f(1),E(null),D("productos"),J("avanzada"),Z("avanzada"),ee("avanzada"),te("avanzada")},Ie=()=>{R(!1),Pe()};return{consultaMensaje:p,consultando:g,error:x,modalOpen:j,step:N,avisoStock:C,editId:A,tabProductos:S,formData:_,setFormData:P,onFormChange:e=>{P(a=>(0,c.A)((0,c.A)({},a),e))},busquedaProducto:I,resultadosProducto:T,busquedaRequerimiento:w,resultadosRequerimiento:O,busquedaRegalo:K,resultadosRegalo:L,busquedaReqRegalo:G,resultadosReqRegalo:U,tabProductosModo:$,tabReqModo:Y,tabRegalosModo:W,tabReqRegaloModo:ae,kitsDisponibles:oe,cargandoKits:ne,errorKits:se,productos:de,requerimientos:ue,regalos:pe,regaloRequerimientos:ge,requerimiento:xe,regaloRequerimiento:je,sugerenciaRequerimiento:Ne,sugerenciaRegalo:Ce,setTabProductos:D,setTabProductosModo:J,setTabReqModo:Z,setTabRegalosModo:ee,setTabReqRegaloModo:te,setBusquedaProducto:M,setBusquedaRequerimiento:z,setBusquedaRegalo:F,setBusquedaReqRegalo:X,setResultadosRequerimiento:B,setResultadosReqRegalo:Q,setProductos:le,setRequerimientos:me,setRegalos:he,setRegaloRequerimientos:ve,setRequerimiento:be,setRegaloRequerimiento:Re,handleConsultarDocumento:async()=>{if(h(""),"dni"!==_.documentoTipo)if(/^\d{11}$/.test(_.documento||""))try{var e;v(!0);const t=await r.pK.consultaRuc(_.documento);var a;if(null!==(e=t.data)&&void 0!==e&&e.success)P(e=>(0,c.A)((0,c.A)({},e),{},{clienteNombre:t.data.razon_social||e.clienteNombre})),h("Datos obtenidos.");else h((null===(a=t.data)||void 0===a?void 0:a.error)||"No se encontraron datos.")}catch(n){console.error("Error consultando RUC:",n),h("Error consultando RUC.")}finally{v(!1)}else h("El RUC debe tener 11 digitos.");else{if(!/^\d{8}$/.test(_.documento||""))return void h("El DNI debe tener 8 digitos.");try{var t;v(!0);const e=await r.pK.consultaDni(_.documento);if(null!==(t=e.data)&&void 0!==t&&t.success){const a="".concat(e.data.nombre||""," ").concat(e.data.apellido||"").trim();P(e=>(0,c.A)((0,c.A)({},e),{},{clienteNombre:a})),h("Datos obtenidos.")}else{var o;h((null===(o=e.data)||void 0===o?void 0:o.error)||"No se encontraron datos.")}}catch(n){console.error("Error consultando DNI:",n),h("Error consultando DNI.")}finally{v(!1)}}},agregarProducto:e=>{const a=ke(e);null!==a&&a<=0?(me(t=>[...t,{id:l(),tipo:"compra",producto_id:e.id,codigo:e.codigo||"",descripcion:e.descripcion||"",marca:e.marca||"",stock:a,cantidad:1,precioVenta:Number(e.precio_venta||0),precioCompra:Number(e.precio_compra||0),proveedor:""}]),k("Producto sin stock enviado a requerimiento de compra.")):(le(t=>[...t,{id:l(),tipo:"stock",producto_id:e.id,codigo:e.codigo||"",descripcion:e.descripcion||"",marca:e.marca||"",stock:a,cantidad:1,precioVenta:Number(e.precio_venta||0),precioCompra:Number(e.precio_compra||0),proveedor:""}]),k("")),M(""),V([])},agregarRequerimiento:async()=>{const e=xe.descripcion.trim(),a=String(xe.codigo||"").trim();if(!e&&!a)return;const t=u(a||e);if(t){if(ue.some(e=>u(e.codigo||e.descripcion)===t))return void k("Requerimiento ya agregado.")}let o=null;if(a)try{if(xe.productoId){const e=await r.rL.getById(xe.productoId);o=(null===e||void 0===e?void 0:e.data)||null}else{const e=await r.rL.getByCodigo(a);o=(null===e||void 0===e?void 0:e.data)||null}}catch(n){o=null}if(o){const t=ke(o),r=null===t?0:Math.max(0,Number(t||0)),n=Math.max(1,Number(xe.cantidad||1)),i=r>0?Math.min(r,n):0,s=Math.max(n-i,0),d={id:l(),producto_id:o.id,codigo:o.codigo||a,descripcion:o.descripcion||e||a,marca:o.marca||xe.marca||"",stock:t,proveedor:xe.proveedor.trim()};return i>0&&le(e=>[...e,(0,c.A)((0,c.A)({},d),{},{tipo:"stock",cantidad:i,precioVenta:Number(o.precio_venta||0),precioCompra:Number(o.precio_compra||0)})]),s>0&&me(e=>[...e,(0,c.A)((0,c.A)({},d),{},{tipo:"compra",cantidad:s,precioVenta:Number(o.precio_venta||0),precioCompra:Number(xe.precioCompra||0)})]),k(s>0&&i>0?"Stock insuficiente: ".concat(o.codigo||o.descripcion,". ").concat(i," en tienda y ").concat(s," a requerimiento."):s>0?"Producto sin stock enviado a requerimiento de compra.":""),be({productoId:null,codigo:"",descripcion:"",marca:"",proveedor:"",cantidad:1,precioCompra:""}),z(""),void B([])}try{const t=await r.XR.crearRequerimientoProducto({descripcion:e,codigo:a,marca:xe.marca||"",precioCompra:Number(xe.precioCompra||0)}),o=(null===t||void 0===t?void 0:t.data)||{},n=o.codigo||a,i=o.descripcion||e||n,s=o.marca||xe.marca||"";me(e=>[...e,{id:l(),tipo:"compra",producto_id:o.id||null,codigo:n,descripcion:i,marca:s,stock:null,cantidad:Number(xe.cantidad||1),precioCompra:Number(xe.precioCompra||0),precioVenta:0,proveedor:xe.proveedor.trim()}]),k(o.existente?"Producto ya existia, se reutilizo.":"Producto creado.")}catch(i){return console.error("Error creando requerimiento:",i),void k("Error creando requerimiento.")}be({productoId:null,codigo:"",descripcion:"",marca:"",proveedor:"",cantidad:1,precioCompra:""}),z(""),B([])},agregarRegalo:e=>{const a=ke(e);null!==a&&a<=0?(ve(t=>[...t,{id:l(),tipo:"compra",producto_id:e.id,codigo:e.codigo||"",descripcion:e.descripcion||"",marca:e.marca||"",stock:a,cantidad:1,precioCompra:Number(e.precio_compra||0),proveedor:""}]),k("Regalo sin stock enviado a requerimiento de compra.")):(he(t=>[...t,{id:l(),tipo:"stock",producto_id:e.id,codigo:e.codigo||"",descripcion:e.descripcion||"",marca:e.marca||"",stock:a,cantidad:1,precioCompra:Number(e.precio_compra||0),proveedor:""}]),k("")),F(""),H([])},agregarRegaloRequerimiento:async()=>{const e=je.descripcion.trim(),a=String(je.codigo||"").trim();if(!e&&!a)return;const t=u(a||e);if(t){if(ge.some(e=>u(e.codigo||e.descripcion)===t))return void k("Requerimiento ya agregado.")}let o=null;if(a)try{if(je.productoId){const e=await r.rL.getById(je.productoId);o=(null===e||void 0===e?void 0:e.data)||null}else{const e=await r.rL.getByCodigo(a);o=(null===e||void 0===e?void 0:e.data)||null}}catch(n){o=null}if(o){const t=ke(o),r=null===t?0:Math.max(0,Number(t||0)),n=Math.max(1,Number(je.cantidad||1)),i=r>0?Math.min(r,n):0,s=Math.max(n-i,0),d={id:l(),producto_id:o.id,codigo:o.codigo||a,descripcion:o.descripcion||e||a,marca:o.marca||je.marca||"",stock:t,proveedor:je.proveedor.trim()};return i>0&&he(e=>[...e,(0,c.A)((0,c.A)({},d),{},{tipo:"stock",cantidad:i,precioCompra:Number(o.precio_compra||0)})]),s>0&&ve(e=>[...e,(0,c.A)((0,c.A)({},d),{},{tipo:"compra",cantidad:s,precioCompra:Number(je.precioCompra||0)})]),k(s>0&&i>0?"Stock insuficiente: ".concat(o.codigo||o.descripcion,". ").concat(i," en tienda y ").concat(s," a requerimiento."):s>0?"Regalo sin stock enviado a requerimiento de compra.":""),Re({productoId:null,codigo:"",descripcion:"",marca:"",proveedor:"",cantidad:1,precioCompra:""}),X(""),void Q([])}try{const t=await r.XR.crearRequerimientoProducto({descripcion:e,codigo:a,marca:je.marca||"",precioCompra:Number(je.precioCompra||0)}),o=(null===t||void 0===t?void 0:t.data)||{},n=o.codigo||a,i=o.descripcion||e||n,s=o.marca||je.marca||"";ve(e=>[...e,{id:l(),tipo:"compra",producto_id:o.id||null,codigo:n,descripcion:i,marca:s,stock:null,cantidad:Number(je.cantidad||1),precioCompra:Number(je.precioCompra||0),proveedor:je.proveedor.trim()}]),k(o.existente?"Producto ya existia, se reutilizo.":"Producto creado.")}catch(i){return console.error("Error creando requerimiento regalo:",i),void k("Error creando requerimiento.")}Re({productoId:null,codigo:"",descripcion:"",marca:"",proveedor:"",cantidad:1,precioCompra:""}),X(""),Q([])},agregarKitVenta:async e=>{try{var a,t;const o=await r.dx.obtenerParaVenta(e.id),n=(null===(a=o.data)||void 0===a?void 0:a.productos_con_stock)||[],i=(null===(t=o.data)||void 0===t?void 0:t.productos_sin_stock)||[];n.length&&le(e=>[...e,...n.map(Ae)]),i.length&&me(e=>[...e,...i.map(Ee)]),n.length||i.length?i.length?k("Kit: productos sin stock enviados a requerimientos."):k("Kit agregado a productos."):k("El kit no tiene productos.")}catch(o){console.error("Error agregando kit:",o),k("Error agregando kit.")}},agregarKitRegalo:async e=>{try{var a,t;const o=await r.dx.obtenerParaVenta(e.id),n=(null===(a=o.data)||void 0===a?void 0:a.productos_con_stock)||[],i=(null===(t=o.data)||void 0===t?void 0:t.productos_sin_stock)||[];n.length&&he(e=>[...e,...n.map(Se)]),i.length&&ve(e=>[...e,...i.map(De)]),n.length||i.length?i.length?k("Kit: regalos sin stock enviados a requerimientos."):k("Kit agregado a regalos."):k("El kit no tiene productos.")}catch(o){console.error("Error agregando kit regalos:",o),k("Error agregando kit.")}},ajustarCantidadProductoStock:(e,a)=>{const t=Math.max(1,Number(a||1)),o=de.find(a=>a.id===e);if(!o)return;const r=ke(o),n=null===r?0:Math.max(0,Number(r||0)),i=n>0?Math.min(n,t):0,s=Math.max(t-i,0);le(a=>a.map(a=>a.id===e?(0,c.A)((0,c.A)({},a),{},{cantidad:i}):a).filter(a=>!(a.id===e&&i<=0))),me(e=>{var a,t,n,i,d,u;const p=m({producto_id:null!==(a=o.producto_id)&&void 0!==a?a:o.id,codigo:o.codigo,descripcion:o.descripcion}),h=e.findIndex(e=>m(e)===p);if(s<=0){if(-1===h)return e;const a=[...e];return a.splice(h,1),a}const g=h>=0?e[h]:{},v=(0,c.A)((0,c.A)({},g),{},{id:g.id||l(),tipo:"compra",producto_id:null!==(t=null!==(n=null!==(i=o.producto_id)&&void 0!==i?i:o.id)&&void 0!==n?n:g.producto_id)&&void 0!==t?t:null,codigo:o.codigo||g.codigo||"",descripcion:o.descripcion||g.descripcion||"",marca:o.marca||g.marca||"",stock:r,cantidad:s,precioCompra:null!==(d=g.precioCompra)&&void 0!==d?d:Number(o.precioCompra||o.precio_compra||0),precioVenta:null!==(u=g.precioVenta)&&void 0!==u?u:Number(o.precioVenta||o.precio_venta||0),proveedor:g.proveedor||""});if(h>=0){const a=[...e];return a[h]=v,a}return[...e,v]}),k(s>0?"Stock insuficiente: ".concat(o.codigo||o.descripcion,". ").concat(i," en tienda y ").concat(s," a requerimiento."):"")},ajustarCantidadRegaloStock:(e,a)=>{const t=Math.max(1,Number(a||1)),o=pe.find(a=>a.id===e);if(!o)return;const r=ke(o),n=null===r?0:Math.max(0,Number(r||0)),i=n>0?Math.min(n,t):0,s=Math.max(t-i,0);he(a=>a.map(a=>a.id===e?(0,c.A)((0,c.A)({},a),{},{cantidad:i}):a).filter(a=>!(a.id===e&&i<=0))),ve(e=>{var a,t,n,i,d;const u=m({producto_id:null!==(a=o.producto_id)&&void 0!==a?a:o.id,codigo:o.codigo,descripcion:o.descripcion}),p=e.findIndex(e=>m(e)===u);if(s<=0){if(-1===p)return e;const a=[...e];return a.splice(p,1),a}const h=p>=0?e[p]:{},g=(0,c.A)((0,c.A)({},h),{},{id:h.id||l(),tipo:"compra",producto_id:null!==(t=null!==(n=null!==(i=o.producto_id)&&void 0!==i?i:o.id)&&void 0!==n?n:h.producto_id)&&void 0!==t?t:null,codigo:o.codigo||h.codigo||"",descripcion:o.descripcion||h.descripcion||"",marca:o.marca||h.marca||"",stock:r,cantidad:s,precioCompra:null!==(d=h.precioCompra)&&void 0!==d?d:Number(o.precioCompra||o.precio_compra||0),proveedor:h.proveedor||""});if(p>=0){const a=[...e];return a[p]=g,a}return[...e,g]}),k(s>0?"Stock insuficiente: ".concat(o.codigo||o.descripcion,". ").concat(i," en tienda y ").concat(s," a requerimiento."):"")},actualizarItem:(e,a,t)=>{e(e=>e.map(e=>e.id===a?(0,c.A)((0,c.A)({},e),t):e))},quitarItem:(e,a)=>{e(e=>e.filter(e=>e.id!==a))},totalVenta:_e,resetFormulario:Pe,cerrarModal:Ie,abrirModal:()=>{const e=null!==t&&void 0!==t&&t.id?String(t.id):"";P(a=>(0,c.A)((0,c.A)({},a),{},{vendedorId:e})),R(!0),f(1)},abrirEdicion:async e=>{if(!e)return;let a=e;if(!s(e))try{const t=await i(e.id);t&&(a=t)}catch(o){return console.error("Error cargando detalle de venta:",o),void alert("No se pudo cargar el detalle de la venta.")}a&&(E(a.id),P({documentoTipo:a.documentoTipo||"dni",documento:a.documento||"",clienteNombre:a.clienteNombre||"",clienteTelefono:a.clienteTelefono||"",vendedorId:a.vendedorId||(null!==t&&void 0!==t&&t.id?String(t.id):""),agencia:a.agencia||"SHALOM",agenciaOtro:a.agenciaOtro||"",destino:a.destino||"",fechaVenta:a.fechaVenta||d(),estadoEnvio:a.estadoEnvio||"PENDIENTE",fechaDespacho:a.fechaDespacho||"",fechaCancelacion:a.fechaCancelacion||"",encargado:a.encargado||"",pVenta:Number(a.pVenta||0),adelanto:a.adelanto||"",rastreoEstado:a.rastreoEstado||"EN TRANSITO",ticket:a.ticket||"",guia:a.guia||"",retiro:a.retiro||"",notas:a.notas||""}),le(a.productos||[]),me(a.requerimientos||[]),he(a.regalos||[]),ve(a.regaloRequerimientos||[]),R(!0),f(1))},registrarVenta:async()=>{if(!_.documento||!_.vendedorId)return void b("Completa el documento. No se detecto vendedor logeado.");if("OTROS"===_.agencia&&!_.agenciaOtro.trim())return void b("Indica la agencia (Otros).");const e=(0,c.A)((0,c.A)({},_),{},{agenciaOtro:"OTROS"===_.agencia?_.agenciaOtro.trim():"",destino:"TIENDA"===_.agencia?"TIENDA":_.destino.trim(),productos:de,requerimientos:ue,regalos:pe,regaloRequerimientos:ge,pVenta:Number(_e||0)});try{A?await r.XR.editar(A,e):await r.XR.crear(e),await n(),Ie()}catch(o){var a,t;console.error("Error guardando venta:",o),b((null===(a=o.response)||void 0===a||null===(t=a.data)||void 0===t?void 0:t.error)||"Error al guardar venta")}},avanzar:()=>{N<3&&f(N+1)},retroceder:()=>{N>1&&f(N-1)}}},A=e=>String(e||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),E=(e,a)=>{if(!e||0===e.length)return"";const t=a.map(e=>"<th>".concat(A(e),"</th>")).join(""),o=e.map(e=>"<tr>".concat(e.map(e=>"<td>".concat(A(e),"</td>")).join(""),"</tr>")).join("");return'\n    <table class="tabla">\n      <thead><tr>'.concat(t,"</tr></thead>\n      <tbody>").concat(o,"</tbody>\n    </table>\n  ")},S=e=>{let{ventas:a,pendientesDia:t,usuariosVentas:r,obtenerVentaDetalle:n,ventaTieneDetalle:i}=e;const[s,c]=(0,o.useState)(!1);return{hojaCargando:s,abrirRotulo:e=>{if(!e)return;const a="".concat(e.agencia||"-")+(e.destino?" - ".concat(e.destino):""),t="OTROS"===e.agencia&&e.agenciaOtro?e.agenciaOtro:"",o=A((e.documentoTipo||"dni").toUpperCase()),r=A(e.documento||"-"),n=A(e.clienteNombre||"-"),i=A(a),s=A(t),c=A(e.id),d='\n      <!doctype html>\n      <html>\n        <head>\n          <meta charset="utf-8" />\n          <title>Rotulo Venta #'.concat(c,'</title>\n          <style>\n            @page { size: A4 landscape; margin: 0; }\n            * { box-sizing: border-box; }\n            body {\n              margin: 0;\n              font-family: \'IBM Plex Sans\', sans-serif;\n              display: flex;\n              align-items: flex-start;\n              justify-content: flex-start;\n              min-height: 100vh;\n              background: #fff;\n              -webkit-print-color-adjust: exact;\n              print-color-adjust: exact;\n            }\n            .sheet {\n              width: calc(297mm - 16mm);\n              height: calc(210mm - 16mm);\n              margin: 8mm;\n              border: 3px solid #f5b000;\n              border-radius: 8mm;\n              padding: 10mm;\n              display: flex;\n              flex-direction: column;\n              align-items: center;\n              justify-content: flex-start;\n              gap: 6mm;\n              text-align: center;\n              position: relative;\n              background: #fff;\n            }\n            .watermark {\n              position: absolute;\n              inset: 16mm 20mm;\n              display: grid;\n              place-items: center;\n              opacity: 0.12;\n              pointer-events: none;\n              z-index: 0;\n            }\n            .watermark img { width: 100%; height: 100%; object-fit: contain; }\n            .logo { width: 50mm; position: absolute; top: 8mm; left: 8mm; }\n            .content {\n              width: 100%;\n              height: 100%;\n              display: flex;\n              flex-direction: column;\n              align-items: center;\n              justify-content: flex-start;\n              gap: 6mm;\n              padding-top: 10mm;\n              z-index: 1;\n            }\n            .header { width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }\n            .dni { font-size: 22mm; font-weight: 900; color: #0f3f91; letter-spacing: 0.04em; width: 100%; text-align: center; margin: 0; }\n            .nombre { font-size: 30mm; font-weight: 900; color: #0f172a; text-transform: uppercase; line-height: 1.02; margin: 0; }\n            .destino { font-size: 20mm; font-weight: 900; color: #0f3f91; text-transform: uppercase; line-height: 1.08; margin: 0; }\n            .agencia { font-size: 18mm; font-weight: 900; color: #0f3f91; text-transform: uppercase; line-height: 1.08; margin: 0; }\n            .print-btn { position: fixed; top: 12px; right: 12px; padding: 10px 16px; border-radius: 999px; border: 1px solid #cbd5f5; background: #fff; cursor: pointer; }\n            @media print {\n              .print-btn { display: none; }\n              body { min-height: auto; }\n            }\n          </style>\n        </head>\n        <body>\n          <button class="print-btn" onclick="window.print()">Imprimir</button>\n          <div class="sheet">\n            <div class="watermark"><img src="/static/img/KRATOS_LOGO.PNG" alt="" /></div>\n            <img src="/static/img/KRATOS_LOGO.PNG" class="logo" alt="Kratos" />\n            <div class="content" id="rotuloContent">\n              <div class="header">\n                <div class="dni" data-base="22">').concat(o," ").concat(r,'</div>\n              </div>\n              <div class="nombre" data-base="30">').concat(n,'</div>\n              <div class="destino" data-base="20">').concat(i,"</div>\n              ").concat(s?'<div class="agencia" data-base="18">'.concat(s,"</div>"):"","\n            </div>\n          </div>\n          <script>\n            (function () {\n              const container = document.getElementById('rotuloContent');\n              if (!container) return;\n              const maxHeight = () => container.parentElement.clientHeight - 28;\n              const elements = Array.from(container.querySelectorAll('[data-base]'));\n              elements.forEach((el) => {\n                const base = Number(el.getAttribute('data-base')) || 18;\n                el.style.fontSize = base + 'mm';\n              });\n              let guard = 80;\n              while (container.scrollHeight > maxHeight() && guard-- > 0) {\n                elements.forEach((el) => {\n                  const current = parseFloat(el.style.fontSize);\n                  const next = Math.max(current - 0.6, 10);\n                  el.style.fontSize = next + 'mm';\n                });\n              }\n            })();\n          <\/script>\n        </body>\n      </html>\n    "),l=window.open("","_blank");l?(l.document.open(),l.document.write(d),l.document.close()):alert("Bloqueador de popups: permite abrir la pestana para imprimir el rotulo.")},abrirHojaRequerimiento:async()=>{if(s)return;const e=window.open("","_blank");if(e){e.document.open(),e.document.write('<!doctype html><html><body style="font-family: sans-serif; padding: 20px;">Cargando hoja...</body></html>'),e.document.close(),c(!0);try{const o=t||[],s=await Promise.all(o.map(async e=>{if(!e)return null;if(i(e))return e;try{return await n(e.id)||null}catch(a){return console.error("Error cargando detalle para hoja:",a),null}})),c=s.filter(e=>!e).length,l=s.filter(Boolean),u=new Map,m=d(),p=e=>"".concat((null===e||void 0===e?void 0:e.codigo)||""," ").concat((null===e||void 0===e?void 0:e.descripcion)||"").trim().toUpperCase(),h=[...a||[]].sort((e,a)=>Number(a.id||0)-Number(e.id||0)),g=new Map(l.map(e=>[e.id,e]));h.forEach(e=>{const a=g.get(e.id)||e;if(!i(a))return;[...a.requerimientos||[],...a.regaloRequerimientos||[]].forEach(e=>{const a=String((null===e||void 0===e?void 0:e.proveedor)||"").trim(),t=Number((null===e||void 0===e?void 0:e.precioCompra)||0);if(!a&&!t)return;const o=p(e);o&&!u.has(o)&&u.set(o,{proveedor:a,precioCompra:t>0?t:""})})});const v=l.map(e=>{const a=r.find(a=>String(a.id)===String(e.vendedorId)),t=e.productos||[],o=e.requerimientos||[],n=e.regalos||[],i=e.regaloRequerimientos||[],s=E(t.map(e=>["".concat(e.codigo||""," ").concat(e.descripcion||"").trim(),e.cantidad||0,"S/ ".concat(Number(e.precioVenta||0).toFixed(2))]),["Producto","Cantidad","Precio venta"]),c=E(o.map(e=>{const a=p(e),t=u.get(a)||{},o=t.proveedor||"",r=t.precioCompra?"S/ ".concat(Number(t.precioCompra||0).toFixed(2)):"";return["".concat(e.codigo||""," ").concat(e.descripcion||"").trim(),e.cantidad||0,o,r]}),["Producto","Cantidad","Proveedor","Compra"]),d=E(n.map(e=>["".concat(e.codigo||""," ").concat(e.descripcion||"").trim(),e.cantidad||0,"S/ ".concat(Number(e.precioCompra||0).toFixed(2))]),["Regalo","Cantidad","Compra"]),l=E(i.map(e=>{const a=p(e),t=u.get(a)||{},o=t.proveedor||"",r=t.precioCompra?"S/ ".concat(Number(t.precioCompra||0).toFixed(2)):"";return["".concat(e.codigo||""," ").concat(e.descripcion||"").trim(),e.cantidad||0,o,r]}),["Regalo","Cantidad","Proveedor","Compra"]);return'\n            <section class="sheet">\n              <div class="sheet-header">\n                <img src="/static/img/KRATOS_LOGO.PNG" alt="Kratos" class="logo" />\n                <div>\n                  <h2>Hoja de requerimiento</h2>\n                  <div class="subtitle">Fecha: '.concat(A(m),'</div>\n                </div>\n              </div>\n              <div class="meta">\n                <div><strong>Venta ID:</strong> ').concat(A(e.id),"</div>\n                <div><strong>Cliente:</strong> ").concat(A(e.clienteNombre||"-"),"</div>\n                <div><strong>Documento:</strong> ").concat(A(e.documento||"-"),"</div>\n                <div><strong>Telefono:</strong> ").concat(A(e.clienteTelefono||"-"),"</div>\n                <div><strong>Fecha venta:</strong> ").concat(A(e.fechaVenta||"-"),"</div>\n                <div><strong>Agencia:</strong> ").concat(A(e.agencia||"-"),"</div>\n                <div><strong>Destino:</strong> ").concat(A(e.destino||"-"),"</div>\n                <div><strong>Vendedor:</strong> ").concat(A((null===a||void 0===a?void 0:a.nombre)||e.vendedorId||"-"),"</div>\n              </div>\n\n              ").concat(s?"<h3>Productos en stock (tienda)</h3>".concat(s):"","\n              ").concat(c?"<h3>Productos a comprar</h3>".concat(c):"","\n              ").concat(d?"<h3>Regalos en stock (tienda)</h3>".concat(d):"","\n              ").concat(l?"<h3>Regalos a comprar</h3>".concat(l):"",'\n\n              <div class="separator">______________________________________________</div>\n            </section>\n          ')}).join(""),x='\n        <!doctype html>\n        <html>\n          <head>\n            <meta charset="utf-8" />\n            <title>Hoja de requerimiento</title>\n            <style>\n              @page { size: A4; margin: 12mm; }\n              * { box-sizing: border-box; }\n              body { margin: 0; font-family: \'IBM Plex Sans\', sans-serif; color: #0f172a; }\n              .page { max-width: 820px; margin: 0 auto; padding: 0 10px 20px; }\n              .print-btn { position: fixed; top: 12px; right: 12px; padding: 8px 14px; border-radius: 999px; border: 1px solid #cbd5f5; background: #fff; cursor: pointer; }\n              .sheet { padding-bottom: 6mm; page-break-inside: avoid; break-inside: avoid; }\n              .sheet + .sheet { border-top: 1px dashed #cbd5f5; margin-top: 6mm; padding-top: 4mm; }\n              .sheet-header { display: flex; align-items: center; gap: 12px; border-bottom: 2px solid #e2e8f0; padding-bottom: 6px; margin-bottom: 8px; }\n              .logo { width: 64px; height: auto; }\n              .subtitle { color: #64748b; font-size: 12px; }\n              .meta { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 3px 10px; font-size: 11px; margin-bottom: 6px; }\n              h2 { margin: 0; font-size: 16px; }\n              h3 { margin: 8px 0 4px; font-size: 12px; }\n              .tabla { width: 100%; border-collapse: collapse; font-size: 10.5px; table-layout: fixed; }\n              .tabla th, .tabla td { border: 1px solid #e2e8f0; padding: 4px 5px; text-align: left; vertical-align: top; }\n              .tabla th:nth-child(3), .tabla td:nth-child(3) { width: 140px; }\n              .tabla th:nth-child(4), .tabla td:nth-child(4) { width: 90px; }\n              .separator { margin-top: 10px; text-align: center; color: #94a3b8; letter-spacing: 0.12em; font-size: 12px; }\n              @media print { .print-btn { display: none; } }\n            </style>\n          </head>\n          <body>\n            <button class="print-btn" onclick="window.print()">Imprimir</button>\n            <div class="page">\n              '.concat(c?'<div style="padding:10px 12px; margin: 10px 0; border: 1px solid #f1c40f; background: #fff9db; font-size: 12px;">No se pudieron cargar detalles para '.concat(c," ventas.</div>"):"","\n              ").concat(v||'<div style="padding:16px">No hay ventas pendientes.</div>',"\n            </div>\n          </body>\n        </html>\n      ");e.document.open(),e.document.write(x),e.document.close()}catch(o){console.error("Error generando hoja de requerimiento:",o),e.document.open(),e.document.write('<!doctype html><html><body style="font-family: sans-serif; padding: 20px;">No se pudo generar la hoja.</body></html>'),e.document.close()}finally{c(!1)}}else alert("Bloqueador de popups: permite abrir la pestana para imprimir la hoja.")}}},D=function(){let{mountedRef:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const a=(0,o.useRef)(!0),t=e||a,n=(0,o.useRef)(!1),i=(0,o.useRef)(1),s=(0,o.useRef)(0),[l,u]=(0,o.useState)([]),[m,p]=(0,o.useState)(1),[h,g]=(0,o.useState)(!0),[v,x]=(0,o.useState)(!1);(0,o.useEffect)(()=>{if(!e)return a.current=!0,()=>{a.current=!1}},[e]);const b=(0,o.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(e&&n.current)return;const a=++s.current;try{n.current=!0,x(!0);const o=200,c=e?i.current+1:1,d=(await r.XR.listar({limite:o,pagina:c,include_detalle:!1})).data||[];if(!t.current||a!==s.current)return;e?(u(e=>[...e,...d]),p(c),i.current=c):(u(d),p(1),i.current=1),g(d.length===o)}catch(o){console.error("Error cargando ventas:",o)}finally{t.current&&a===s.current&&(n.current=!1,x(!1))}},[t]);(0,o.useEffect)(()=>{b(!1)},[b]);const j=(0,o.useCallback)((e,a)=>{u(t=>(t||[]).map(t=>t.id===e?(0,c.A)((0,c.A)({},t),a):t))},[]),R=(0,o.useCallback)(e=>{null!==e&&void 0!==e&&e.id&&u(a=>(a||[]).map(a=>a.id===e.id?(0,c.A)((0,c.A)({},a),e):a))},[]),N=(0,o.useCallback)((e,a)=>{if(!e)return;if(!("PEDIDO_LISTO"===(e.estadoPedido||"PICKING"))&&("ENVIADO"===a||"CANCELADO"===a))return void alert("El pedido debe estar en PEDIDO_LISTO para enviar o cancelar.");const t=d(),o={estadoEnvio:a,fechaDespacho:"ENVIADO"===a||"VISITA"===a?e.fechaDespacho||t:e.fechaDespacho,fechaCancelacion:"CANCELADO"===a?e.fechaCancelacion||t:e.fechaCancelacion,rastreoEstado:"CANCELADO"===a?"ENTREGADO":e.rastreoEstado};j(e.id,o),r.XR.actualizarEstado(e.id,o).then(()=>b(!1)).catch(e=>{console.error("Error actualizando estado de envio:",e),b(!1)})},[b,j]),f=(0,o.useMemo)(()=>l||[],[l]),C=(0,o.useMemo)(()=>(l||[]).filter(e=>"PENDIENTE"===(e.estadoEnvio||"PENDIENTE")),[l]);return{ventas:l,ventasPagina:m,ventasHasMore:h,ventasLoading:v,ventasListado:f,pendientesDia:C,cargarVentas:b,actualizarVentaDetalle:R,handleEstadoEnvioChange:N,setVentas:u}},_=()=>{const e=(0,o.useRef)(!0),[a,t]=(0,o.useState)([]),[i,c]=(0,o.useState)(null),{ventas:d,ventasHasMore:l,ventasLoading:u,ventasListado:m,pendientesDia:g,cargarVentas:v,actualizarVentaDetalle:x,handleEstadoEnvioChange:b}=D({mountedRef:e}),{detalleVenta:j,detalleCargando:f,detalleError:q,abrirDetalleVenta:y,obtenerVentaDetalle:A,resetDetalle:E,ventaTieneDetalle:_}=C(x),P=k({mountedRef:e,usuarioActual:i,cargarVentas:v,obtenerVentaDetalle:A,ventaTieneDetalle:_}),{hojaCargando:I,abrirRotulo:M,abrirHojaRequerimiento:T}=S({ventas:d,pendientesDia:g,usuariosVentas:a,obtenerVentaDetalle:A,ventaTieneDetalle:_});(0,o.useEffect)(()=>{e.current=!0;(async()=>{try{const a=await r.Xg.listar(),o=Array.isArray(a.data)?a.data:[];if(!e.current)return;t(o.filter(e=>"ventas"===e.rol))}catch(a){console.error("Error cargando usuarios:",a)}})();try{const e=localStorage.getItem("usuario");e&&c(JSON.parse(e))}catch(a){console.error("Error leyendo usuario actual:",a)}return()=>{e.current=!1}},[]);return(0,n.jsxs)("div",{className:"ventas-container",children:[(0,n.jsxs)("div",{className:"page-header",children:[(0,n.jsxs)("div",{className:"page-header__title",children:[(0,n.jsx)("h5",{children:"Control de Ventas"}),(0,n.jsx)("span",{className:"page-header__subtitle",children:"Registro de ventas y control de envios"})]}),(0,n.jsxs)("div",{className:"page-header__actions",children:[(0,n.jsxs)("span",{className:"status-pill",children:["Ventas: ",m.length]}),(0,n.jsx)("button",{type:"button",className:"icon-btn icon-btn--view",onClick:T,title:"Hoja de requerimiento","aria-label":"Hoja de requerimiento",disabled:I,children:(0,n.jsx)("svg",{viewBox:"0 0 24 24","aria-hidden":"true",children:(0,n.jsx)("path",{d:"M6 3h9l5 5v13a1 1 0 0 1-1 1H6a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1zm8 1.5V9h4.5L14 4.5zM8 12h8v2H8v-2zm0 4h8v2H8v-2z"})})}),(0,n.jsx)("button",{type:"button",className:"icon-btn icon-btn--edit",onClick:P.abrirModal,title:"Nueva venta","aria-label":"Nueva venta",children:(0,n.jsxs)("svg",{viewBox:"0 0 24 24","aria-hidden":"true",children:[(0,n.jsx)("path",{d:"M11 5h2v14h-2z"}),(0,n.jsx)("path",{d:"M5 11h14v2H5z"})]})})]})]}),(0,n.jsx)(N,{ventasListado:m,usuariosVentas:a,estadosEnvio:h,ventasHasMore:l,ventasLoading:u,onCargarMas:()=>v(!0),onEstadoEnvioChange:b,onAbrirEdicion:P.abrirEdicion,onAbrirDetalle:y,onAbrirRotulo:M,onEliminar:async e=>{if(window.confirm("Deseas eliminar esta venta?"))try{await r.XR.eliminar(e),await v()}catch(a){console.error("Error eliminando venta:",a)}}}),(0,n.jsx)(s,{venta:j,cargando:f,error:q,onClose:E}),P.modalOpen&&(0,n.jsx)(R,{title:P.editId?"Editar venta #".concat(P.editId):"Nueva venta",onClose:P.cerrarModal,step:P.step,error:P.error,avisoStock:P.avisoStock,editId:P.editId,onBack:P.retroceder,onNext:P.avanzar,onSave:P.registrarVenta,formData:P.formData,setFormData:P.setFormData,consultaMensaje:P.consultaMensaje,consultando:P.consultando,usuarioActual:i,agencias:p,estadosEnvio:h,onConsultarDocumento:P.handleConsultarDocumento,onFormChange:P.onFormChange,tabProductos:P.tabProductos,tabProductosModo:P.tabProductosModo,tabReqModo:P.tabReqModo,busquedaProducto:P.busquedaProducto,resultadosProducto:P.resultadosProducto,busquedaRequerimiento:P.busquedaRequerimiento,resultadosRequerimiento:P.resultadosRequerimiento,cargandoKits:P.cargandoKits,errorKits:P.errorKits,kitsDisponibles:P.kitsDisponibles,productos:P.productos,setProductos:P.setProductos,requerimientos:P.requerimientos,setTabProductos:P.setTabProductos,setTabProductosModo:P.setTabProductosModo,setTabReqModo:P.setTabReqModo,setBusquedaProducto:P.setBusquedaProducto,setBusquedaRequerimiento:P.setBusquedaRequerimiento,setResultadosRequerimiento:P.setResultadosRequerimiento,agregarProducto:P.agregarProducto,agregarKitVenta:P.agregarKitVenta,agregarRequerimiento:P.agregarRequerimiento,actualizarItem:P.actualizarItem,quitarItem:P.quitarItem,setRequerimientos:P.setRequerimientos,setRequerimiento:P.setRequerimiento,requerimiento:P.requerimiento,sugerenciaRequerimiento:P.sugerenciaRequerimiento,ajustarCantidadProductoStock:P.ajustarCantidadProductoStock,tabRegalosModo:P.tabRegalosModo,setTabRegalosModo:P.setTabRegalosModo,busquedaRegalo:P.busquedaRegalo,setBusquedaRegalo:P.setBusquedaRegalo,resultadosRegalo:P.resultadosRegalo,agregarRegalo:P.agregarRegalo,agregarKitRegalo:P.agregarKitRegalo,regalos:P.regalos,setRegalos:P.setRegalos,tabReqRegaloModo:P.tabReqRegaloModo,setTabReqRegaloModo:P.setTabReqRegaloModo,busquedaReqRegalo:P.busquedaReqRegalo,setBusquedaReqRegalo:P.setBusquedaReqRegalo,resultadosReqRegalo:P.resultadosReqRegalo,setResultadosReqRegalo:P.setResultadosReqRegalo,setRegaloRequerimiento:P.setRegaloRequerimiento,regaloRequerimiento:P.regaloRequerimiento,sugerenciaRegalo:P.sugerenciaRegalo,agregarRegaloRequerimiento:P.agregarRegaloRequerimiento,regaloRequerimientos:P.regaloRequerimientos,setRegaloRequerimientos:P.setRegaloRequerimientos,ajustarCantidadRegaloStock:P.ajustarCantidadRegaloStock})]})}}}]);