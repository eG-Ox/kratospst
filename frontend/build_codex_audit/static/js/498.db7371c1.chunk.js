"use strict";(self.webpackChunksistema_inventario_frontend=self.webpackChunksistema_inventario_frontend||[]).push([[498],{218(e,s,a){a.d(s,{A:()=>n});var t=a(950);const n=()=>{const e=(0,t.useRef)(!0);return(0,t.useEffect)(()=>(e.current=!0,()=>{e.current=!1}),[]),e}},498(e,s,a){a.r(s),a.d(s,{default:()=>i});var t=a(950),n=a(112),c=a(218),r=a(414);const i=e=>{var s,a;let{usuario:i}=e;const l=(0,c.A)(),[d,o]=(0,t.useState)(null),[h,m]=(0,t.useState)([]),[x,j]=(0,t.useState)([]),[u,v]=(0,t.useState)([]),[b,p]=(0,t.useState)(!1),[N,g]=(0,t.useState)(!1),[k,f]=(0,t.useState)([]),[y,S]=(0,t.useState)([]),[M,C]=(0,t.useState)("resumen"),[E,w]=(0,t.useState)(""),[_,V]=(0,t.useState)(""),[A,L]=(0,t.useState)(""),[D,I]=(0,t.useState)(""),[P,T]=(0,t.useState)("minimo"),[F,R]=(0,t.useState)(!0),[B,U]=(0,t.useState)(""),H=(0,t.useCallback)(async()=>{if(!b&&!N)try{g(!0);const e=await n.XR.detalle({tipo:"producto"});if(!l.current)return;v(e.data||[]),p(!0)}catch(B){console.error("Error cargando detalle de ventas:",B)}finally{l.current&&g(!1)}},[b,N,l]),O=(0,t.useCallback)(async()=>{try{R(!0);const[e,s,a,t,c]=await Promise.all([n.uA.obtenerEstadisticas(),n.uA.obtener({limite:10,pagina:1}),n.XR.listar({include_detalle:!1,limite:500}),n.rL.getAll(),n.FZ.getAll()]);if(!l.current)return;o(e.data),m(s.data||[]),j(a.data||[]),f(t.data||[]),S(c.data||[]),U("")}catch(B){console.error("Error cargando dashboard:",B),l.current&&U("Error al cargar datos del dashboard")}finally{l.current&&R(!1)}},[l]);(0,t.useEffect)(()=>{O()},[O]),(0,t.useEffect)(()=>{"inventario"!==M||b||H()},[M,b,H]);const q=(0,t.useMemo)(()=>_||A?x.filter(e=>{const s=(e.fechaVenta||"").slice(0,10);return!(_&&s<_)&&!(A&&s>A)}):x,[x,_,A]),X=(0,t.useMemo)(()=>new Set((q||[]).map(e=>Number(e.id))),[q]),z=(0,t.useMemo)(()=>{const e=(new Date).toISOString().slice(0,10);return{total:q.length,pendientes:q.filter(e=>"PENDIENTE"===(e.estadoEnvio||"PENDIENTE")).length,enviados:q.filter(e=>"ENVIADO"===(e.estadoEnvio||"")).length,ventasHoy:q.filter(s=>(s.fechaVenta||"").slice(0,10)===e).length,totalVenta:q.reduce((e,s)=>e+Number(s.pVenta||0),0)}},[q]),Z=(0,t.useMemo)(()=>{const e=new Map;return q.forEach(s=>{const a=(s.fechaVenta||"").slice(0,10)||"Sin fecha";e.set(a,(e.get(a)||0)+Number(s.pVenta||0))}),Array.from(e.entries()).map(e=>{let[s,a]=e;return{fecha:s,total:a}}).sort((e,s)=>e.fecha>s.fecha?1:-1).slice(-10)},[q]),W=(0,t.useMemo)(()=>{const e=new Map;return q.forEach(s=>{const a=s.vendedorNombre||s.vendedorId||"Sin vendedor";e.set(a,(e.get(a)||0)+Number(s.pVenta||0))}),Array.from(e.entries()).map(e=>{let[s,a]=e;return{label:s,total:a}}).sort((e,s)=>s.total-e.total).slice(0,8)},[q]),Y=(0,t.useMemo)(()=>{const e=new Map;return(u||[]).forEach(s=>{if(X.size>0&&!X.has(Number(s.ventaId)))return;const a="".concat(s.codigo||""," ").concat(s.descripcion||"").trim()||"Sin codigo",t=Number(s.precioVenta||0)*Number(s.cantidad||0);e.set(a,(e.get(a)||0)+t)}),Array.from(e.entries()).map(e=>{let[s,a]=e;return{label:s,total:a}}).sort((e,s)=>s.total-e.total).slice(0,8)},[u,X]),$=e=>{const s=new Date,a=e=>e.toISOString().slice(0,10);if("hoy"===e){const e=a(s);return V(e),void L(e)}if("semana"===e){const e=new Date(s);return e.setDate(s.getDate()-6),V(a(e)),void L(a(s))}if("mes"===e){const e=new Date(s.getFullYear(),s.getMonth(),1);return V(a(e)),void L(a(s))}"todo"===e&&(V(""),L(""))},G=(0,t.useMemo)(()=>{const e=k.filter(e=>Number(e.stock||0)<=0).length,s=k.filter(e=>Number(e.stock||0)>0&&Number(e.stock||0)<=2).length;return{sinStock:e,bajo:s,ok:Math.max(k.length-e-s,0)}},[k,2]),J=(0,t.useMemo)(()=>(k||[]).filter(e=>Number(e.stock||0)<=2),[k,2]),K=(0,t.useMemo)(()=>{const e=new Set;return(y||[]).forEach(s=>{const a=String(s.codigo||"").trim().toUpperCase();a&&e.add(a)}),e},[y]),Q=(0,t.useMemo)(()=>(k||[]).filter(e=>{const s=String(e.marca||"").trim();if(!s)return!0;const a=s.toUpperCase();return!!/^M\d{4}$/.test(a)&&!K.has(a)}),[k,K]),ee=(0,t.useMemo)(()=>{if(!E.trim())return q;const e=E.toLowerCase();return q.filter(s=>String(s.id).includes(e)||(s.clienteNombre||"").toLowerCase().includes(e)||(s.documento||"").toLowerCase().includes(e))},[q,E]),se=(0,t.useMemo)(()=>{const e=D.toLowerCase();let s=k;return e&&(s=s.filter(s=>"".concat(s.codigo||""," ").concat(s.descripcion||""," ").concat(s.marca||"").toLowerCase().includes(e))),"minimo"===P?s=s.filter(e=>Number(e.stock||0)<=2):"sin-stock"===P&&(s=s.filter(e=>Number(e.stock||0)<=0)),s},[k,D,P,2]),ae=async(e,s)=>{try{const a=await e,t=new Blob([a.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),n=URL.createObjectURL(t),c=document.createElement("a");c.href=n,c.setAttribute("download",s),document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(n)}catch(a){console.error("Error descargando Excel:",a)}};return(0,r.jsxs)("div",{className:"dashboard-container",children:[(0,r.jsxs)("div",{className:"dashboard-header",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h1",{children:"Dashboard"}),(0,r.jsxs)("p",{children:["Bienvenido, ",null===i||void 0===i?void 0:i.nombre,"!"]})]}),(0,r.jsxs)("div",{className:"dashboard-header__actions",children:["ventas"===M&&(0,r.jsx)("button",{type:"button",className:"btn-secondary",onClick:()=>ae(n.XR.exportarExcel({fecha_inicio:_||void 0,fecha_fin:A||void 0}),"ventas.xlsx"),children:"Exportar Excel"}),"inventario"===M&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("button",{type:"button",className:"btn-secondary",onClick:()=>ae(n.rL.exportarExcel(),"productos.xlsx"),children:"Exportar productos"}),(0,r.jsx)("button",{type:"button",className:"btn-secondary",onClick:()=>ae(n.rL.exportarStockMinimo(2),"stock_minimo.xlsx"),children:"Exportar stock minimo"})]}),"resumen"===M&&(0,r.jsx)("button",{type:"button",className:"btn-secondary",onClick:()=>ae(n.rL.exportarStockMinimo(2),"stock_minimo.xlsx"),children:"Exportar stock minimo"})]})]}),B&&(0,r.jsx)("div",{className:"error-message",children:B}),F?(0,r.jsx)("div",{className:"loading",children:"Cargando datos..."}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"dashboard-tabs",children:[(0,r.jsx)("button",{className:"resumen"===M?"active":"",onClick:()=>C("resumen"),children:"Resumen"}),(0,r.jsx)("button",{className:"ventas"===M?"active":"",onClick:()=>C("ventas"),children:"Ventas"}),(0,r.jsx)("button",{className:"inventario"===M?"active":"",onClick:()=>C("inventario"),children:"Productos & Inventario"})]}),(0,r.jsxs)("div",{className:"dashboard-stats",children:[(0,r.jsxs)("div",{className:"stat-card",children:[(0,r.jsx)("div",{className:"stat-icon",children:"\ud83c\udfed"}),(0,r.jsxs)("div",{className:"stat-content",children:[(0,r.jsx)("h3",{children:"Total de M\xe1quinas"}),(0,r.jsx)("p",{className:"stat-number",children:(null===d||void 0===d?void 0:d.total_maquinas)||0})]})]}),(0,r.jsxs)("div",{className:"stat-card",children:[(0,r.jsx)("div",{className:"stat-icon",children:"\ud83d\udce6"}),(0,r.jsxs)("div",{className:"stat-content",children:[(0,r.jsx)("h3",{children:"Stock Total"}),(0,r.jsx)("p",{className:"stat-number",children:(null===d||void 0===d?void 0:d.total_stock)||0})]})]}),(0,r.jsxs)("div",{className:"stat-card",children:[(0,r.jsx)("div",{className:"stat-icon",children:"\ud83d\udce5"}),(0,r.jsxs)("div",{className:"stat-content",children:[(0,r.jsx)("h3",{children:"Ingresos Hoy"}),(0,r.jsx)("p",{className:"stat-number",children:(null===d||void 0===d||null===(s=d.ingresos_hoy)||void 0===s?void 0:s.cantidad)||0})]})]}),(0,r.jsxs)("div",{className:"stat-card",children:[(0,r.jsx)("div",{className:"stat-icon",children:"\ud83d\udce4"}),(0,r.jsxs)("div",{className:"stat-content",children:[(0,r.jsx)("h3",{children:"Salidas Hoy"}),(0,r.jsx)("p",{className:"stat-number",children:(null===d||void 0===d||null===(a=d.salidas_hoy)||void 0===a?void 0:a.cantidad)||0})]})]}),(0,r.jsxs)("div",{className:"stat-card",children:[(0,r.jsx)("div",{className:"stat-icon",children:"\u26a0\ufe0f"}),(0,r.jsxs)("div",{className:"stat-content",children:[(0,r.jsxs)("h3",{children:["Stock Bajo (\u2264 ",2,")"]}),(0,r.jsx)("p",{className:"stat-number",children:J.length})]})]}),(0,r.jsxs)("div",{className:"stat-card",children:[(0,r.jsx)("div",{className:"stat-icon",children:"\ud83c\udff7\ufe0f"}),(0,r.jsxs)("div",{className:"stat-content",children:[(0,r.jsx)("h3",{children:"Productos sin marca registrada"}),(0,r.jsx)("p",{className:"stat-number",children:Q.length})]})]}),(0,r.jsxs)("div",{className:"stat-card",children:[(0,r.jsx)("div",{className:"stat-icon",children:"\ud83d\udcb8"}),(0,r.jsxs)("div",{className:"stat-content",children:[(0,r.jsx)("h3",{children:"Total Ventas"}),(0,r.jsxs)("p",{className:"stat-number",children:["S/ ",z.totalVenta.toFixed(2)]})]})]})]}),"resumen"===M&&(0,r.jsx)("div",{className:"dashboard-content",children:(0,r.jsxs)("div",{className:"dashboard-grid",children:[(0,r.jsxs)("div",{className:"dashboard-panel",children:[(0,r.jsx)("h2",{children:"Alertas de stock m\xednimo"}),J.length>0?(0,r.jsxs)("table",{className:"movements-table",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:"Codigo"}),(0,r.jsx)("th",{children:"Producto"}),(0,r.jsx)("th",{children:"Stock"})]})}),(0,r.jsx)("tbody",{children:J.map(e=>(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:e.codigo}),(0,r.jsx)("td",{children:e.descripcion}),(0,r.jsx)("td",{className:"stock-alert",children:e.stock})]},e.id))})]}):(0,r.jsx)("p",{className:"empty-message",children:"Sin alertas de stock."})]}),(0,r.jsxs)("div",{className:"dashboard-panel",children:[(0,r.jsx)("h2",{children:"Productos sin marca registrada"}),Q.length>0?(0,r.jsxs)("table",{className:"movements-table",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:"Codigo"}),(0,r.jsx)("th",{children:"Producto"}),(0,r.jsx)("th",{children:"Marca"})]})}),(0,r.jsx)("tbody",{children:Q.slice(0,20).map(e=>(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:e.codigo}),(0,r.jsx)("td",{children:e.descripcion}),(0,r.jsx)("td",{className:"stock-alert",children:e.marca||"Sin marca"})]},"sin-marca-".concat(e.id)))})]}):(0,r.jsx)("p",{className:"empty-message",children:"Todo ok con marcas registradas."})]}),(0,r.jsxs)("div",{className:"dashboard-panel",children:[(0,r.jsx)("h2",{children:"\xdaltimos Movimientos"}),(0,r.jsx)("div",{className:"panel-actions",children:(0,r.jsx)("button",{type:"button",className:"btn-secondary",onClick:O,children:"Actualizar"})}),h.length>0?(0,r.jsxs)("table",{className:"movements-table",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:"M\xe1quina"}),(0,r.jsx)("th",{children:"Tipo"}),(0,r.jsx)("th",{children:"Cantidad"}),(0,r.jsx)("th",{children:"Usuario"}),(0,r.jsx)("th",{children:"Fecha"})]})}),(0,r.jsx)("tbody",{children:h.map(e=>(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:e.maquina_codigo}),(0,r.jsx)("td",{className:"type-".concat(e.tipo),children:e.tipo}),(0,r.jsx)("td",{children:e.cantidad}),(0,r.jsx)("td",{children:e.usuario_nombre}),(0,r.jsx)("td",{children:new Date(e.fecha).toLocaleString("es-ES")})]},e.id))})]}):(0,r.jsx)("p",{className:"empty-message",children:"No hay movimientos registrados"})]}),(0,r.jsxs)("div",{className:"dashboard-panel",children:[(0,r.jsx)("h2",{children:"Ventas \xfaltimos 10 d\xedas"}),(0,r.jsx)("div",{className:"chart-line",children:(0,r.jsx)("svg",{viewBox:"0 0 300 120",preserveAspectRatio:"none",children:Z.length>1&&(0,r.jsx)("polyline",{fill:"none",stroke:"#2563eb",strokeWidth:"3",points:Z.map((e,s)=>{const a=Math.max(...Z.map(e=>e.total),1),t=s/(Z.length-1)*300,n=120-e.total/a*110-5;return"".concat(t,",").concat(n)}).join(" ")})})}),(0,r.jsx)("div",{className:"chart",children:Z.map(e=>{const s=Math.max(...Z.map(e=>e.total),1),a=Math.max(e.total/s*100,6);return(0,r.jsxs)("div",{className:"chart-bar",children:[(0,r.jsx)("div",{className:"chart-bar__fill",style:{height:"".concat(a,"%")}}),(0,r.jsx)("span",{className:"chart-bar__label",children:e.fecha.slice(5)})]},e.fecha)})})]}),(0,r.jsxs)("div",{className:"dashboard-panel",children:[(0,r.jsx)("h2",{children:"Distribuci\xf3n de stock"}),(0,r.jsx)("div",{className:"chart-pie",children:(0,r.jsx)("svg",{viewBox:"0 0 120 120",children:(()=>{const e=G.sinStock+G.bajo+G.ok||1,s=[{value:G.sinStock,color:"#dc2626"},{value:G.bajo,color:"#f59e0b"},{value:G.ok,color:"#10b981"}];let a=0;return s.map((s,t)=>{const n=a/e*2*Math.PI;a+=s.value;const c=a/e*2*Math.PI,i=c-n>Math.PI?1:0,l=60+50*Math.cos(n),d=60+50*Math.sin(n),o=60+50*Math.cos(c),h=60+50*Math.sin(c),m="M60 60 L".concat(l," ").concat(d," A50 50 0 ").concat(i," 1 ").concat(o," ").concat(h," Z");return(0,r.jsx)("path",{d:m,fill:s.color},t)})})()})}),(0,r.jsxs)("div",{className:"stock-distribucion",children:[(0,r.jsxs)("div",{className:"stock-pill danger",children:["Sin stock: ",G.sinStock]}),(0,r.jsxs)("div",{className:"stock-pill warn",children:["Stock bajo: ",G.bajo]}),(0,r.jsxs)("div",{className:"stock-pill ok",children:["Stock ok: ",G.ok]})]})]})]})}),"ventas"===M&&(0,r.jsx)("div",{className:"dashboard-content",children:(0,r.jsxs)("div",{className:"dashboard-grid",children:[(0,r.jsxs)("div",{className:"dashboard-panel",children:[(0,r.jsx)("h2",{children:"Resumen de ventas"}),(0,r.jsxs)("div",{className:"ventas-resumen",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Ventas hoy:"})," ",z.ventasHoy]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Pendientes:"})," ",z.pendientes]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Enviados:"})," ",z.enviados]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("strong",{children:"Total ventas:"})," ",z.total]})]})]}),(0,r.jsxs)("div",{className:"dashboard-panel",children:[(0,r.jsx)("h2",{children:"Buscar venta"}),(0,r.jsxs)("div",{className:"ventas-filtros-fecha",children:[(0,r.jsx)("input",{type:"date",value:_,onChange:e=>V(e.target.value)}),(0,r.jsx)("input",{type:"date",value:A,onChange:e=>L(e.target.value)})]}),(0,r.jsxs)("div",{className:"ventas-rango",children:[(0,r.jsx)("button",{type:"button",onClick:()=>$("hoy"),children:"Hoy"}),(0,r.jsx)("button",{type:"button",onClick:()=>$("semana"),children:"Semana"}),(0,r.jsx)("button",{type:"button",onClick:()=>$("mes"),children:"Mes"}),(0,r.jsx)("button",{type:"button",onClick:()=>$("todo"),children:"Todo"})]}),(0,r.jsx)("input",{type:"text",placeholder:"ID, cliente o documento",value:E,onChange:e=>w(e.target.value)}),(0,r.jsx)("div",{className:"table-container",children:ee.length>0?(0,r.jsxs)("table",{className:"movements-table",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:"ID"}),(0,r.jsx)("th",{children:"Cliente"}),(0,r.jsx)("th",{children:"Fecha"}),(0,r.jsx)("th",{children:"Estado"}),(0,r.jsx)("th",{children:"Total"})]})}),(0,r.jsx)("tbody",{children:ee.slice(0,12).map(e=>(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:e.id}),(0,r.jsx)("td",{children:e.clienteNombre}),(0,r.jsx)("td",{children:e.fechaVenta}),(0,r.jsx)("td",{children:e.estadoEnvio}),(0,r.jsxs)("td",{children:["S/ ",Number(e.pVenta||0).toFixed(2)]})]},e.id))})]}):(0,r.jsx)("p",{className:"empty-message",children:"Sin ventas para mostrar."})})]})]})}),"inventario"===M&&(0,r.jsxs)("div",{className:"dashboard-content",children:[(0,r.jsxs)("div",{className:"dashboard-panel",children:[(0,r.jsxs)("div",{className:"inventario-filtros",children:[(0,r.jsx)("input",{type:"text",placeholder:"Buscar producto",value:D,onChange:e=>I(e.target.value)}),(0,r.jsxs)("select",{value:P,onChange:e=>T(e.target.value),children:[(0,r.jsx)("option",{value:"minimo",children:"Stock m\xednimo"}),(0,r.jsx)("option",{value:"sin-stock",children:"Sin stock"}),(0,r.jsx)("option",{value:"todos",children:"Todos"})]})]}),(0,r.jsx)("div",{className:"table-container",children:se.length>0?(0,r.jsxs)("table",{className:"movements-table",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{children:"Codigo"}),(0,r.jsx)("th",{children:"Producto"}),(0,r.jsx)("th",{children:"Marca"}),(0,r.jsx)("th",{children:"Stock"}),(0,r.jsx)("th",{children:"Precio venta"})]})}),(0,r.jsx)("tbody",{children:se.slice(0,20).map(e=>(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{children:e.codigo}),(0,r.jsx)("td",{children:e.descripcion}),(0,r.jsx)("td",{children:e.marca}),(0,r.jsx)("td",{className:Number(e.stock||0)<=2?"stock-alert":"",children:e.stock}),(0,r.jsxs)("td",{children:["S/ ",Number(e.precio_venta||0).toFixed(2)]})]},e.id))})]}):(0,r.jsx)("p",{className:"empty-message",children:"No hay productos."})})]}),(0,r.jsxs)("div",{className:"dashboard-grid",children:[(0,r.jsxs)("div",{className:"dashboard-panel",children:[(0,r.jsx)("h2",{children:"Top ventas por vendedor"}),(0,r.jsx)("div",{className:"chart-hbar",children:W.map(e=>{const s=Math.max(...W.map(e=>e.total),1),a=Math.max(e.total/s*100,6);return(0,r.jsxs)("div",{className:"hbar-row",children:[(0,r.jsx)("span",{className:"hbar-label",children:e.label}),(0,r.jsx)("div",{className:"hbar-track",children:(0,r.jsx)("div",{className:"hbar-fill",style:{width:"".concat(a,"%")}})}),(0,r.jsxs)("span",{className:"hbar-value",children:["S/ ",e.total.toFixed(2)]})]},e.label)})})]}),(0,r.jsxs)("div",{className:"dashboard-panel",children:[(0,r.jsx)("h2",{children:"Top ventas por producto"}),(0,r.jsx)("div",{className:"chart-hbar",children:Y.map(e=>{const s=Math.max(...Y.map(e=>e.total),1),a=Math.max(e.total/s*100,6);return(0,r.jsxs)("div",{className:"hbar-row",children:[(0,r.jsx)("span",{className:"hbar-label",children:e.label}),(0,r.jsx)("div",{className:"hbar-track",children:(0,r.jsx)("div",{className:"hbar-fill",style:{width:"".concat(a,"%")}})}),(0,r.jsxs)("span",{className:"hbar-value",children:["S/ ",e.total.toFixed(2)]})]},e.label)})})]})]})]})]})]})}}}]);