"use strict";(self.webpackChunksistema_inventario_frontend=self.webpackChunksistema_inventario_frontend||[]).push([[805],{805(e,a,s){s.r(a),s.d(a,{default:()=>c});var i=s(555),t=s(950),d=s(112),n=s(414);const r=["PENDIENTE","ENVIADO","CANCELADO","VISITA"],l=["EN TRANSITO","DESTINO","ENTREGADO"],c=()=>{const[e,a]=(0,t.useState)([]),[s,c]=(0,t.useState)([]),[o,h]=(0,t.useState)(null),[u,x]=(0,t.useState)(!1),v=(0,t.useRef)(0),j=(0,t.useRef)(0);(0,t.useEffect)(()=>{(async()=>{try{const e=await d.Xg.listar(),a=Array.isArray(e.data)?e.data:[];c(a)}catch(e){console.error("Error cargando usuarios:",e)}})()},[]);const m=(0,t.useCallback)(async()=>{const e=++v.current;try{const s=await d.XR.listar({include_detalle:!1,limite:400});if(e!==v.current)return;a(s.data||[])}catch(s){console.error("Error cargando ventas:",s)}},[]),N=(0,t.useCallback)((e,s)=>{a(a=>(a||[]).map(a=>a.id===e?(0,i.A)((0,i.A)({},a),s):a)),h(a=>a&&a.id===e?(0,i.A)((0,i.A)({},a),s):a)},[]);(0,t.useEffect)(()=>{m()},[m]);const g=(0,t.useCallback)(async e=>{if(null!==e&&void 0!==e&&e.id)try{await d.XR.actualizarEnvio(e.id,{ticket:e.ticket||"",guia:e.guia||"",retiro:e.retiro||"",rastreoEstado:e.rastreoEstado||"EN TRANSITO"})}catch(a){console.error("Error actualizando envio:",a),m()}},[m]),E=(0,t.useCallback)((e,a)=>{if(!("PEDIDO_LISTO"===(e.estadoPedido||"PICKING"))&&("ENVIADO"===a||"CANCELADO"===a))return void alert("El pedido debe estar en PEDIDO_LISTO para enviar o cancelar.");const s=(new Date).toISOString().slice(0,10),i={estadoEnvio:a};"ENVIADO"!==a&&"VISITA"!==a||(i.fechaDespacho=e.fechaDespacho||s),"CANCELADO"===a&&(i.fechaCancelacion=e.fechaCancelacion||s,i.rastreoEstado="ENTREGADO"),N(e.id,i),d.XR.actualizarEstado(e.id,i).then(()=>m()).catch(e=>{console.error("Error actualizando estado de envio:",e),m()})},[m,N]),p=(0,t.useCallback)(async e=>{if(null===e||void 0===e||!e.id)return;const a=++j.current;h(e),x(!0);try{const s=await d.XR.obtener(e.id);if(a!==j.current)return;h((null===s||void 0===s?void 0:s.data)||e)}catch(s){console.error("Error cargando detalle de venta en envios:",s),a===j.current&&h(e)}finally{a===j.current&&x(!1)}},[]),C=(0,t.useCallback)(()=>{j.current+=1,h(null),x(!1)},[]),A=(0,t.useMemo)(()=>(e||[]).filter(e=>"PENDIENTE"===e.estadoEnvio||"ENVIADO"===e.estadoEnvio),[e]);return(0,n.jsxs)("div",{className:"envios-container",children:[(0,n.jsxs)("div",{className:"page-header",children:[(0,n.jsxs)("div",{className:"page-header__title",children:[(0,n.jsx)("h5",{children:"Control de Envios"}),(0,n.jsx)("span",{className:"page-header__subtitle",children:"Pendientes y enviados"})]}),(0,n.jsx)("div",{className:"page-header__actions",children:(0,n.jsxs)("span",{className:"status-pill",children:["Registros: ",A.length]})})]}),(0,n.jsx)("div",{className:"table-container",children:0===A.length?(0,n.jsx)("div",{className:"empty-message",children:"No hay envios pendientes o enviados."}):(0,n.jsxs)("table",{className:"envios-table",children:[(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{children:[(0,n.jsx)("th",{children:"Documento"}),(0,n.jsx)("th",{children:"Cliente"}),(0,n.jsx)("th",{children:"Vendedor"}),(0,n.jsx)("th",{children:"Agencia"}),(0,n.jsx)("th",{children:"Destino"}),(0,n.jsx)("th",{children:"Estado envio"}),(0,n.jsx)("th",{children:"Estado pedido"}),(0,n.jsx)("th",{children:"Fecha despacho"}),(0,n.jsx)("th",{children:"Ticket"}),(0,n.jsx)("th",{children:"Guia"}),(0,n.jsx)("th",{children:"Retiro"}),(0,n.jsx)("th",{children:"Estado rastreo"}),(0,n.jsx)("th",{children:"Detalle"})]})}),(0,n.jsx)("tbody",{children:A.map(e=>{const a=s.find(a=>String(a.id)===String(e.vendedorId)),t="OTROS"===e.agencia?"".concat(e.agencia," (").concat(e.agenciaOtro,")"):e.agencia;return(0,n.jsxs)("tr",{children:[(0,n.jsx)("td",{children:e.documento}),(0,n.jsx)("td",{children:e.clienteNombre||"-"}),(0,n.jsx)("td",{children:(null===a||void 0===a?void 0:a.nombre)||e.vendedorId}),(0,n.jsx)("td",{children:t}),(0,n.jsx)("td",{children:e.destino||"-"}),(0,n.jsx)("td",{children:(0,n.jsx)("select",{value:e.estadoEnvio,onChange:a=>E(e,a.target.value),className:"estado-select ".concat(e.estadoEnvio.toLowerCase()),children:r.map(a=>(0,n.jsx)("option",{value:a,disabled:("ENVIADO"===a||"CANCELADO"===a)&&"PEDIDO_LISTO"!==(e.estadoPedido||"PICKING"),children:a},a))})}),(0,n.jsx)("td",{children:(0,n.jsx)("span",{className:"pedido-pill ".concat(String(e.estadoPedido||"PICKING").toLowerCase()),children:e.estadoPedido||"PICKING"})}),(0,n.jsx)("td",{children:e.fechaDespacho||"-"}),(0,n.jsx)("td",{children:(0,n.jsx)("input",{type:"text",value:e.ticket||"",disabled:"ENVIADO"!==e.estadoEnvio,onChange:a=>N(e.id,{ticket:a.target.value}),onBlur:a=>g((0,i.A)((0,i.A)({},e),{},{ticket:a.target.value}))})}),(0,n.jsx)("td",{children:(0,n.jsx)("input",{type:"text",value:e.guia||"",disabled:"ENVIADO"!==e.estadoEnvio,onChange:a=>N(e.id,{guia:a.target.value}),onBlur:a=>g((0,i.A)((0,i.A)({},e),{},{guia:a.target.value}))})}),(0,n.jsx)("td",{children:(0,n.jsx)("input",{type:"text",value:e.retiro||"",disabled:"ENVIADO"!==e.estadoEnvio,onChange:a=>N(e.id,{retiro:a.target.value}),onBlur:a=>g((0,i.A)((0,i.A)({},e),{},{retiro:a.target.value}))})}),(0,n.jsx)("td",{children:(0,n.jsx)("select",{value:e.rastreoEstado||"EN TRANSITO",disabled:"CANCELADO"===e.estadoEnvio,onChange:a=>{const s=a.target.value;N(e.id,{rastreoEstado:s}),g((0,i.A)((0,i.A)({},e),{},{rastreoEstado:s}))},children:l.map(e=>(0,n.jsx)("option",{value:e,children:e},e))})}),(0,n.jsx)("td",{children:(0,n.jsx)("button",{type:"button",className:"icon-btn icon-btn--view",onClick:()=>p(e),title:"Detalle","aria-label":"Detalle",children:(0,n.jsx)("svg",{viewBox:"0 0 24 24","aria-hidden":"true",children:(0,n.jsx)("path",{d:"M12 5c4.5 0 8.3 2.7 10 6.5C20.3 15.3 16.5 18 12 18S3.7 15.3 2 11.5C3.7 7.7 7.5 5 12 5zm0 2c-3.2 0-6 1.7-7.6 4.5C6 14.3 8.8 16 12 16s6-1.7 7.6-4.5C18 8.7 15.2 7 12 7zm0 2.5a2.5 2.5 0 1 1 0 5a2.5 2.5 0 0 1 0-5z"})})})})]},e.id)})})]})}),o&&(0,n.jsx)("div",{className:"modal-overlay",role:"dialog","aria-modal":"true",children:(0,n.jsxs)("div",{className:"modal-content",children:[(0,n.jsxs)("div",{className:"modal-header",children:[(0,n.jsxs)("h2",{children:["Detalle pedido #",o.id]}),(0,n.jsx)("button",{type:"button",className:"btn-icon",onClick:C,"aria-label":"Cerrar",children:"X"})]}),(0,n.jsx)("div",{className:"modal-body",children:u?(0,n.jsx)("div",{className:"loading",children:"Cargando detalle..."}):(0,n.jsxs)("div",{className:"envios-detalle-grid",children:[(0,n.jsxs)("div",{className:"envios-detalle-card",children:[(0,n.jsx)("h3",{children:"Productos"}),0===(o.productos||[]).length?(0,n.jsx)("div",{className:"empty-message",children:"Sin productos."}):(0,n.jsx)("ul",{className:"envios-detalle-list",children:(o.productos||[]).map(e=>(0,n.jsxs)("li",{children:[e.codigo," ",e.descripcion," x",e.cantidad]},e.id))})]}),(0,n.jsxs)("div",{className:"envios-detalle-card",children:[(0,n.jsx)("h3",{children:"Requerimientos"}),0===(o.requerimientos||[]).length?(0,n.jsx)("div",{className:"empty-message",children:"Sin requerimientos."}):(0,n.jsx)("ul",{className:"envios-detalle-list",children:(o.requerimientos||[]).map(e=>(0,n.jsxs)("li",{children:[e.codigo," ",e.descripcion," x",e.cantidad]},e.id))})]}),(0,n.jsxs)("div",{className:"envios-detalle-card",children:[(0,n.jsx)("h3",{children:"Regalos"}),0===[...o.regalos||[],...o.regaloRequerimientos||[]].length?(0,n.jsx)("div",{className:"empty-message",children:"Sin regalos."}):(0,n.jsx)("ul",{className:"envios-detalle-list",children:[...o.regalos||[],...o.regaloRequerimientos||[]].map(e=>(0,n.jsxs)("li",{children:[e.codigo," ",e.descripcion," x",e.cantidad]},e.id))})]})]})})]})})]})}}}]);