"use strict";(self.webpackChunksistema_inventario_frontend=self.webpackChunksistema_inventario_frontend||[]).push([[356],{356(e,a,n){n.r(a),n.d(a,{default:()=>d});var i=n(555),r=n(950),t=n(534),s=n(112),c=n(918),o=n(414);const d=()=>{const[e,a]=(0,r.useState)([]),[n,d]=(0,r.useState)(""),[l,u]=(0,r.useState)(!1),[m,p]=(0,r.useState)(""),[h,v]=(0,r.useState)(""),[g,x]=(0,r.useState)(null),[j,N]=(0,r.useState)(null),[f,k]=(0,r.useState)(!1),[b,y]=(0,r.useState)(!1),w=(0,r.useCallback)(e=>{switch(String(e||"").toLowerCase()){case"producto":return"Producto";case"regalo":return"Regalo";case"requerimiento":return"Requerimiento";case"regalo_requerimiento":return"Req. Regalo";default:return"Item"}},[]),_=(0,r.useRef)(null),C=(0,r.useRef)(null),S=(0,r.useRef)(null),I=(0,r.useRef)(null),P=(0,r.useRef)(!1),E=(0,r.useRef)(""),R=(0,r.useRef)(0),A=(0,r.useCallback)(()=>{try{const e=new(window.AudioContext||window.webkitAudioContext),a=e.createOscillator(),n=e.createGain();a.type="sine",a.frequency.setValueAtTime(880,e.currentTime),n.gain.setValueAtTime(.12,e.currentTime),a.connect(n),n.connect(e.destination),a.start(),a.stop(e.currentTime+.12),a.onended=()=>{e.close()}}catch(e){}},[]),T=(0,r.useCallback)(async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{u(!0),p("");const n=await s.XR.pickingPendientes(e);a(n.data||[])}catch(n){console.error("Error cargando picking:",n),p("No se pudo cargar los pedidos pendientes.")}finally{u(!1)}},[]);(0,r.useEffect)(()=>{T()},[T]);const O=(0,r.useCallback)(()=>{if(P.current=!1,y(!1),S.current){const e=S.current;S.current=null,"function"===typeof e.stop?e.stop():"function"===typeof e.then&&e.then(e=>{var a;return null===e||void 0===e||null===(a=e.stop)||void 0===a?void 0:a.call(e)}).catch(()=>{})}C.current&&"function"===typeof C.current.reset&&C.current.reset()},[]),D=(0,r.useCallback)(()=>{O(),I.current&&(I.current.getTracks().forEach(e=>e.stop()),I.current=null),_.current&&(_.current.srcObject=null),k(!1)},[O]),Q=(0,r.useCallback)(async e=>{try{p(""),v(""),await s.XR.confirmarPicking({detalleId:e.detalleId,codigo:e.codigo,ventaId:null===g||void 0===g?void 0:g.ventaId,cantidad:1}),v("Salida registrada. Pedido actualizado."),N(null),a(a=>a.map(a=>{const n=(a.items||[]).map(a=>{if(a.detalleId!==e.detalleId)return a;const n=Math.min(Number(a.cantidad||0),Number(a.cantidadPicked||0)+1),r=Math.max(Number(a.cantidad||0)-n,0);return(0,i.A)((0,i.A)({},a),{},{cantidadPicked:n,pendiente:r})}),r=n.filter(e=>e.pendiente>0),t=Number(a.pendientesSinStock||0),s=(0,i.A)((0,i.A)({},a),{},{items:n,estadoPedido:0===r.length&&0===t?"PEDIDO_LISTO":a.estadoPedido});return(null===g||void 0===g?void 0:g.ventaId)===a.ventaId&&x(s),s}))}catch(t){var n,r;console.error("Error confirmando picking:",t),p((null===(n=t.response)||void 0===n||null===(r=n.data)||void 0===r?void 0:r.error)||"No se pudo confirmar la salida.")}},[g]),q=(0,r.useCallback)(e=>{var a;const n=Date.now();if(e===E.current&&n-R.current<1200)return;E.current=e,R.current=n;const i=(0,c.B)(e),r=e=>String(e||"").trim().toUpperCase().replace(/[^A-Z0-9]/g,"");let t="";if(i.ok&&null!==(a=i.data)&&void 0!==a&&a.codigo)t=i.data.codigo;else{const a=String(e||"").trim();t=a.replace(/\r/g,"").split(/[\n,;/\s]+/g).map(e=>e.trim()).filter(Boolean)[0]||a}if(!t)return void p(i.error||"QR invalido");const s=r(t);if(d(t),j){const a=r(j.codigo),n=r(e);s===a||n.includes(a)?(A(),Q(j),D()):(p("ERROR NO CORRESPONDE AL PEDIDO"),D())}else A(),T({codigo:t}),D()},[T,Q,D,j,A]),B=(0,r.useCallback)(async()=>{p(""),E.current="",R.current=0,window.isSecureContext?(C.current||(C.current=new t.sx),k(!0)):p("Para usar la camara en celular necesitas HTTPS.")},[]),L=(0,r.useCallback)(()=>{if(!P.current&&_.current&&C.current){P.current=!0,y(!0);try{const e={video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}},audio:!1},a=C.current.decodeFromConstraints(e,_.current,(e,a)=>{e&&P.current?q(e.getText()):a&&"NotFoundException"!==a.name&&console.error("Error ZXing:",a)});S.current=a}catch(e){console.error("Error iniciando camara:",e),p("No se pudo acceder a la camara. Revisa permisos del navegador."),k(!1)}}},[q]),M=(0,r.useCallback)(async()=>{"undefined"!==typeof window&&window.Android&&"function"===typeof window.Android.openQrScanner?window.Android.openQrScanner():(f||await B(),P.current?O():L())},[B,f,O,L]);(0,r.useEffect)(()=>()=>{D()},[D]),(0,r.useEffect)(()=>{const e=e=>{e&&q(String(e))};return window.handleNativeQr=e,()=>{window.handleNativeQr===e&&delete window.handleNativeQr}},[q]),(0,r.useEffect)(()=>{if(!f)return;const e=setTimeout(()=>L(),150);return()=>clearTimeout(e)},[f,L]);const V=(0,r.useMemo)(()=>n.trim()?e.filter(e=>(e.items||[]).some(e=>e.codigo===n.trim())):e,[n,e]),X=async()=>{n.trim()?await T({codigo:n.trim()}):await T()},z=(0,r.useMemo)(()=>((null===g||void 0===g?void 0:g.items)||[]).filter(e=>e.pendiente>0),[g]),U=Number((null===g||void 0===g?void 0:g.pendientesSinStock)||0);return(0,o.jsxs)("div",{className:"picking-container",children:[(0,o.jsxs)("div",{className:"page-header",children:[(0,o.jsxs)("div",{className:"page-header__title",children:[(0,o.jsx)("h5",{children:"Picking de ventas"}),(0,o.jsx)("span",{className:"page-header__subtitle",children:"Escanea y registra la salida de productos"})]}),(0,o.jsx)("div",{className:"page-header__actions",children:(0,o.jsxs)("span",{className:"status-pill",children:["Pendientes: ",e.length]})})]}),(0,o.jsxs)("div",{className:"picking-layout",children:[(0,o.jsxs)("div",{className:"picking-card",children:[(0,o.jsxs)("div",{className:"picking-card__header",children:[(0,o.jsx)("h3",{children:"Pedidos pendientes"}),(0,o.jsxs)("div",{className:"header-actions",children:[(0,o.jsx)("input",{type:"text",value:n,onChange:e=>d(e.target.value),placeholder:"Buscar por codigo",onKeyDown:e=>{"Enter"===e.key&&X()}}),(0,o.jsx)("button",{type:"button",className:"btn-primary",onClick:X,children:"Buscar"}),(0,o.jsx)("button",{type:"button",className:"btn-secondary",onClick:()=>T(),children:"Actualizar"})]})]}),l?(0,o.jsx)("div",{className:"empty-message",children:"Cargando pedidos..."}):0===V.length?(0,o.jsx)("div",{className:"empty-message",children:"No hay pedidos pendientes."}):(0,o.jsx)("div",{className:"picking-list",children:V.map(e=>(0,o.jsxs)("button",{type:"button",className:"picking-venta ".concat((null===g||void 0===g?void 0:g.ventaId)===e.ventaId?"active":""),onClick:()=>(e=>{x(e),N(null)})(e),children:[(0,o.jsxs)("div",{children:[(0,o.jsxs)("strong",{children:["Venta #",e.ventaId]}),(0,o.jsx)("span",{children:e.clienteNombre||"-"})]}),(0,o.jsx)("div",{className:"pedido-pill ".concat(String(e.estadoPedido||"PICKING").toLowerCase()),children:e.estadoPedido||"PICKING"}),(0,o.jsxs)("div",{className:"picking-venta__meta",children:[(0,o.jsx)("span",{children:e.documento||"-"}),(0,o.jsxs)("span",{children:[e.agencia," ",e.destino?"- ".concat(e.destino):""]}),(0,o.jsx)("span",{children:e.fechaVenta||"-"})]})]},e.ventaId))})]}),(0,o.jsxs)("div",{className:"picking-card",children:[(0,o.jsx)("div",{className:"picking-card__header",children:(0,o.jsx)("h3",{children:"Items del pedido"})}),g?(0,o.jsxs)("div",{className:"picking-items",children:[0===z.length?(0,o.jsx)("div",{className:"empty-message",children:U>0?(0,o.jsxs)("span",{children:["Sin stock para picking. Pendientes por compra: ",U,"."]}):(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("span",{children:"Todos los items fueron pickeados."}),(0,o.jsx)("button",{type:"button",className:"btn-primary",onClick:async()=>{if(g)try{p(""),await s.XR.cerrarPedido({ventaId:g.ventaId}),a(e=>e.filter(e=>e.ventaId!==g.ventaId)),x(null),v("Pedido cerrado y marcado como PEDIDO_LISTO.")}catch(i){var e,n;console.error("Error cerrando pedido:",i),p((null===(e=i.response)||void 0===e||null===(n=e.data)||void 0===n?void 0:n.error)||"No se pudo cerrar el pedido.")}},children:"Cerrar pedido"})]})}):null,z.map(e=>{var a;return(0,o.jsxs)("div",{className:"picking-item",children:[(0,o.jsxs)("div",{children:[(0,o.jsxs)("div",{className:"picking-item__title",children:[(0,o.jsx)("strong",{children:e.codigo}),e.tipo?(0,o.jsx)("span",{className:"picking-tag picking-tag--".concat(String(e.tipo).toLowerCase()),children:w(e.tipo)}):null]}),(0,o.jsx)("span",{children:e.descripcion})]}),(0,o.jsxs)("div",{className:"picking-item__stats",children:[(0,o.jsxs)("span",{children:["Pendiente: ",e.pendiente]}),(0,o.jsxs)("span",{children:["Stock: ",null!==(a=e.stock)&&void 0!==a?a:"-"]})]}),(0,o.jsx)("div",{className:"picking-item__actions",children:(0,o.jsx)("button",{type:"button",className:"btn-camera","aria-label":"Escanear codigo",onClick:()=>{N(e),M()},children:(0,o.jsx)("svg",{viewBox:"0 0 24 24","aria-hidden":"true",children:(0,o.jsx)("path",{d:"M4 7h3l2-2h6l2 2h3a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2zm8 3a4 4 0 1 0 .001 8.001A4 4 0 0 0 12 10z"})})})})]},e.detalleId)})]}):(0,o.jsx)("div",{className:"empty-message",children:"Selecciona una venta para ver sus productos."}),m&&(0,o.jsx)("div",{className:"alert alert-error",children:m}),h&&(0,o.jsx)("div",{className:"alert alert-success",children:h})]})]}),f&&(0,o.jsxs)("div",{className:"camera-modal",role:"dialog","aria-modal":"true","aria-label":"Camara",children:[(0,o.jsx)("div",{className:"camera-modal__backdrop",onClick:D}),(0,o.jsxs)("div",{className:"camera-modal__content",children:[(0,o.jsxs)("div",{className:"camera-modal__header",children:[(0,o.jsx)("h3",{children:"Escaner de codigo"}),(0,o.jsx)("button",{type:"button",className:"btn-icon",onClick:D,children:"X"})]}),(0,o.jsxs)("div",{className:"camera-modal__preview",children:[(0,o.jsx)("video",{ref:_,autoPlay:!0,playsInline:!0,muted:!0,onLoadedMetadata:L,onCanPlay:L}),(0,o.jsxs)("div",{className:"scan-overlay","aria-hidden":"true",children:[(0,o.jsx)("div",{className:"scan-cross"}),(0,o.jsx)("div",{className:"scan-line"})]})]}),(0,o.jsxs)("p",{className:"camera-note",children:[j?"Escaneando ".concat(j.codigo,"... (1 escaneo = 1 salida)"):"Escanea el codigo del producto.",b?" Escaneo activo.":""]}),m&&(0,o.jsx)("div",{className:"camera-error",children:m})]})]})]})}},918(e,a,n){n.d(a,{B:()=>i});const i=e=>{const a=String(e||"").trim();if(!a)return{ok:!1,error:"QR vacio"};const n=a.replace(/\r/g,""),i=n.includes("\n")?"\n":",",r=n.split(i).map(e=>String(e).trim().replace(/,+$/,"")).filter(e=>e.length>0);if(1===r.length)return{ok:!0,partial:!0,data:{codigo:r[0]}};if(r.length<5)return{ok:!1,error:"QR invalido: se esperan 5 campos (codigo, tipo_maquina, marca, descripcion, ubicacion)"};const t=r[0],s=r[1],c=r[2],o=r[r.length-1],d=r.slice(3,r.length-1).join(",").trim();if(!t||!s||!c||!d||!o)return{ok:!1,error:"QR invalido: campos vacios"};const l=String(o).trim().toUpperCase().match(/^([A-H])\s*(\d+)$/);if(!l)return{ok:!1,error:"Ubicacion invalida. Usa A1, A2, B1..."};const u=Number(l[2]);if(!Number.isInteger(u)||u<=0)return{ok:!1,error:"Numero de ubicacion invalido"};const m=l[1];return{ok:!0,data:{codigo:t,tipo_maquina:s,marca:c,descripcion:d,ubicacion:"".concat(m).concat(u),ubicacion_letra:m,ubicacion_numero:u}}}}}]);