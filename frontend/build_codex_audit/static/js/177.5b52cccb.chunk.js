"use strict";(self.webpackChunksistema_inventario_frontend=self.webpackChunksistema_inventario_frontend||[]).push([[177],{177(e,t,r){r.r(t),r.d(t,{default:()=>d});var c=r(555),i=r(950),a=r(112),o=r(218),s=r(414);const n={nombre:"",descripcion:"",activo:!0,productos:[]},d=()=>{const e=(0,o.A)(),[t,r]=(0,i.useState)([]),[d,l]=(0,i.useState)(!0),[u,h]=(0,i.useState)(""),[m,p]=(0,i.useState)(!1),[x,j]=(0,i.useState)(!1),[b,v]=(0,i.useState)(null),[N,g]=(0,i.useState)(n),[f,y]=(0,i.useState)({}),[k,_]=(0,i.useState)(""),[A,C]=(0,i.useState)([]),[E,w]=(0,i.useState)([]),S=(0,i.useCallback)(async()=>{try{l(!0);const t=await a.dx.listar();if(!e.current)return;r(t.data||[]),h("")}catch(t){console.error("Error cargando kits:",t),e.current&&h("Error al cargar kits")}finally{e.current&&l(!1)}},[e]),P=(0,i.useCallback)(async t=>{try{const r=await a.DI.buscarProductos({q:t,limit:20});if(!e.current)return;C(r.data||[])}catch(r){console.error("Error buscando productos:",r)}},[e]),D=(0,i.useCallback)(async function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];const r=Array.from(new Set(t.filter(Boolean)));if(!r.length)return;const i=r.filter(e=>!f[e]);if(i.length)try{const t=await Promise.all(i.map(e=>a.DI.obtenerProducto(e,{}))),r={};if(t.forEach(e=>{const t=null===e||void 0===e?void 0:e.data;null!==t&&void 0!==t&&t.id&&(r[t.id]=t)}),!e.current)return;y(e=>(0,c.A)((0,c.A)({},e),r)),g(e=>(0,c.A)((0,c.A)({},e),{},{productos:e.productos.map(e=>{const t=r[e.producto_id];return t?(0,c.A)((0,c.A)({},e),{},{codigo:e.codigo||t.codigo,descripcion:e.descripcion||t.descripcion,marca:e.marca||t.marca}):e})}))}catch(o){console.error("Error cargando productos por ids:",o)}},[e,f]);(0,i.useEffect)(()=>{S()},[S]),(0,i.useEffect)(()=>{const e=setTimeout(()=>{const e=k.trim();e.length<1?C([]):P(e)},350);return()=>clearTimeout(e)},[k,P]);const I=()=>{g(n),v(null),_(""),C([]),w([]),j(!1)},F=(e,t)=>{w(r=>{var i,a,o;const s=[...r],n=s[e];if(!n)return r;const d=Number((null!==(i=t.cantidad)&&void 0!==i?i:n.cantidad)||0),l=Number((null!==(a=t.precio_unitario)&&void 0!==a?a:n.precio_unitario)||0),u=Number((null!==(o=t.precio_final)&&void 0!==o?o:n.precio_final)||0);return s[e]=(0,c.A)((0,c.A)((0,c.A)({},n),t),{},{cantidad:d,precio_unitario:l,precio_final:u,subtotal:d*u}),s})},K=(0,i.useMemo)(()=>N.productos.reduce((e,t)=>e+Number(t.subtotal||0),0),[N.productos]);return(0,s.jsxs)("div",{className:"kits-container",children:[(0,s.jsxs)("div",{className:"kits-header",children:[(0,s.jsx)("h1",{children:"Kits"}),(0,s.jsx)("button",{className:"btn-primary",onClick:()=>{I(),p(!0)},children:"+ Nuevo Kit"})]}),u&&(0,s.jsx)("div",{className:"error-message",children:u}),d?(0,s.jsx)("div",{className:"loading",children:"Cargando kits..."}):(0,s.jsx)("div",{className:"kits-table-container",children:t.length>0?(0,s.jsxs)("table",{className:"kits-table",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:"Nombre"}),(0,s.jsx)("th",{children:"Descripcion"}),(0,s.jsx)("th",{children:"Precio total"}),(0,s.jsx)("th",{children:"Estado"}),(0,s.jsx)("th",{className:"icon-col",title:"Acciones",children:(0,s.jsx)("span",{className:"icon-label","aria-label":"Acciones",children:"..."})})]})}),(0,s.jsx)("tbody",{children:t.map(t=>(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:t.nombre}),(0,s.jsx)("td",{children:t.descripcion||"-"}),(0,s.jsx)("td",{children:Number(t.precio_total||0).toFixed(2)}),(0,s.jsx)("td",{children:t.activo?"Activo":"Inactivo"}),(0,s.jsxs)("td",{className:"acciones",children:[(0,s.jsx)("button",{className:"btn-edit",onClick:()=>(async t=>{try{const r=(await a.dx.getById(t.id)).data;if(!e.current)return;v(t),g({nombre:r.nombre||"",descripcion:r.descripcion||"",activo:!!r.activo,productos:(r.productos||[]).map(e=>({producto_id:e.producto_id,cantidad:e.cantidad,precio_unitario:Number(e.precio_unitario||0),precio_final:Number(e.precio_final||0),subtotal:Number(e.subtotal||0)}))});const c=(r.productos||[]).map(e=>e.producto_id);D(c),p(!0)}catch(r){console.error("Error obteniendo kit:",r),e.current&&h("Error al obtener kit")}})(t),children:"Editar"}),(0,s.jsx)("button",{className:"btn-secondary",onClick:()=>(async t=>{try{await a.dx.toggle(t),await S()}catch(r){console.error("Error cambiando estado:",r),e.current&&h("Error al actualizar estado")}})(t.id),children:t.activo?"Desactivar":"Activar"}),(0,s.jsx)("button",{className:"btn-delete",onClick:()=>(async t=>{if(window.confirm("Deseas eliminar este kit?"))try{await a.dx.eliminar(t),await S()}catch(r){console.error("Error eliminando kit:",r),e.current&&h("Error al eliminar kit")}})(t.id),children:"Eliminar"})]})]},t.id))})]}):(0,s.jsx)("p",{className:"empty-message",children:"No hay kits registrados"})}),m&&(0,s.jsx)("div",{className:"modal-overlay",children:(0,s.jsxs)("div",{className:"modal-content",children:[(0,s.jsxs)("div",{className:"modal-header",children:[(0,s.jsx)("h2",{children:b?"Editar Kit":"Nuevo Kit"}),(0,s.jsx)("button",{type:"button",className:"btn-icon",onClick:()=>{I(),p(!1)},children:"X"})]}),(0,s.jsxs)("form",{onSubmit:async t=>{if(t.preventDefault(),h(""),N.nombre)try{const t=(0,c.A)((0,c.A)({},N),{},{productos:N.productos});b?await a.dx.editar(b.id,t):await a.dx.crear(t),e.current&&p(!1),I(),await S()}catch(o){var r,i;if(console.error("Error guardando kit:",o),e.current)h((null===(r=o.response)||void 0===r||null===(i=r.data)||void 0===i?void 0:i.error)||"Error al guardar kit")}else h("Nombre es requerido")},children:[(0,s.jsxs)("div",{className:"modal-body",children:[(0,s.jsxs)("div",{className:"form-row",children:[(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{children:"Nombre *"}),(0,s.jsx)("input",{type:"text",value:N.nombre,onChange:e=>g((0,c.A)((0,c.A)({},N),{},{nombre:e.target.value}))})]}),(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{children:"Activo"}),(0,s.jsxs)("select",{value:N.activo?"1":"0",onChange:e=>g((0,c.A)((0,c.A)({},N),{},{activo:"1"===e.target.value})),children:[(0,s.jsx)("option",{value:"1",children:"Activo"}),(0,s.jsx)("option",{value:"0",children:"Inactivo"})]})]})]}),(0,s.jsx)("div",{className:"form-row",children:(0,s.jsxs)("div",{className:"form-group",children:[(0,s.jsx)("label",{children:"Descripcion"}),(0,s.jsx)("input",{type:"text",value:N.descripcion,onChange:e=>g((0,c.A)((0,c.A)({},N),{},{descripcion:e.target.value}))})]})}),(0,s.jsxs)("div",{className:"kit-items",children:[(0,s.jsxs)("div",{className:"kit-items-header",children:[(0,s.jsx)("h3",{children:"Productos del kit"}),(0,s.jsx)("button",{type:"button",className:"btn-secondary",onClick:()=>{w(N.productos.map(e=>(0,c.A)({},e))),_(""),C([]),j(!0)},children:"Seleccionar productos"})]}),0===N.productos.length?(0,s.jsx)("p",{className:"empty-message",children:"Agrega productos al kit."}):(0,s.jsx)("div",{className:"kit-items-list",children:(0,s.jsxs)("table",{className:"kits-table compact",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:"Producto"}),(0,s.jsx)("th",{children:"Cantidad"}),(0,s.jsx)("th",{children:"Precio Final"}),(0,s.jsx)("th",{children:"Subtotal"})]})}),(0,s.jsx)("tbody",{children:N.productos.map((e,t)=>(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:e.codigo||e.descripcion?"".concat(e.codigo||""," ").concat(e.descripcion||"").trim():f[e.producto_id]?"".concat(f[e.producto_id].codigo||""," ").concat(f[e.producto_id].descripcion||"").trim():e.producto_id?"ID ".concat(e.producto_id):""}),(0,s.jsx)("td",{children:e.cantidad}),(0,s.jsx)("td",{children:Number(e.precio_final||0).toFixed(2)}),(0,s.jsx)("td",{children:Number(e.subtotal||0).toFixed(2)})]},"".concat(e.producto_id,"-").concat(t)))})]})})]})]}),(0,s.jsxs)("div",{className:"modal-footer",children:[(0,s.jsxs)("div",{className:"kit-total",children:["Total: ",K.toFixed(2)]}),(0,s.jsx)("button",{type:"submit",className:"btn-success",children:b?"Guardar":"Crear"}),(0,s.jsx)("button",{type:"button",className:"btn-secondary",onClick:()=>{I(),p(!1)},children:"Cancelar"})]})]})]})}),x&&(0,s.jsx)("div",{className:"modal-overlay",children:(0,s.jsxs)("div",{className:"modal-content modal-content--wide",children:[(0,s.jsxs)("div",{className:"modal-header",children:[(0,s.jsx)("h2",{children:"Seleccionar productos"}),(0,s.jsx)("button",{type:"button",className:"btn-icon",onClick:()=>j(!1),children:"X"})]}),(0,s.jsxs)("div",{className:"modal-body",children:[(0,s.jsxs)("div",{className:"kit-products-toolbar",children:[(0,s.jsx)("input",{type:"text",placeholder:"Buscar por codigo, descripcion o marca",value:k,onChange:e=>_(e.target.value)}),(0,s.jsxs)("div",{className:"kit-products-actions",children:[(0,s.jsx)("button",{type:"button",className:"btn-secondary",onClick:()=>j(!1),children:"Cancelar"}),(0,s.jsx)("button",{type:"button",className:"btn-primary",onClick:()=>{g(e=>(0,c.A)((0,c.A)({},e),{},{productos:E.map(e=>{const t=Number(e.cantidad||0),r=Number(e.precio_unitario||0),i=Number(e.precio_final||0);return(0,c.A)((0,c.A)({},e),{},{cantidad:t,precio_unitario:r,precio_final:i,subtotal:t*i})})})),j(!1)},children:"Guardar productos"})]})]}),(0,s.jsx)("div",{className:"resultados",children:A.map(e=>(0,s.jsxs)("button",{type:"button",className:"resultado-item",onClick:()=>(e=>{if(null===e||void 0===e||!e.id)return;const t=Number(e.precio_venta||0);y(t=>(0,c.A)((0,c.A)({},t),{},{[e.id]:e})),w(r=>{const i=r.findIndex(t=>String(t.producto_id)===String(e.id));if(-1===i)return[...r,{producto_id:e.id,codigo:e.codigo,descripcion:e.descripcion,marca:e.marca,cantidad:1,precio_unitario:t,precio_final:t,subtotal:t}];const a=[...r],o=Number(a[i].cantidad||0)+1,s=Number(a[i].precio_final||t);return a[i]=(0,c.A)((0,c.A)({},a[i]),{},{cantidad:o,subtotal:o*s}),a}),_(""),C([])})(e),children:[e.codigo," - ",e.descripcion," (",e.marca,")"]},"kit-search-".concat(e.id,"-").concat(e.codigo)))}),(0,s.jsx)("div",{className:"kit-products-table",children:0===E.length?(0,s.jsx)("p",{className:"empty-message",children:"No hay productos agregados."}):(0,s.jsxs)("table",{className:"kits-table compact",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{children:"Producto"}),(0,s.jsx)("th",{children:"Cantidad"}),(0,s.jsx)("th",{children:"Precio Unit."}),(0,s.jsx)("th",{children:"Precio Final"}),(0,s.jsx)("th",{children:"Subtotal"}),(0,s.jsx)("th",{})]})}),(0,s.jsx)("tbody",{children:E.map((e,t)=>(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{children:e.codigo||e.descripcion?"".concat(e.codigo||""," ").concat(e.descripcion||"").trim():f[e.producto_id]?"".concat(f[e.producto_id].codigo||""," ").concat(f[e.producto_id].descripcion||"").trim():e.producto_id?"ID ".concat(e.producto_id):""}),(0,s.jsx)("td",{children:(0,s.jsx)("input",{type:"number",min:"1",value:e.cantidad,onChange:e=>F(t,{cantidad:e.target.value})})}),(0,s.jsx)("td",{children:(0,s.jsx)("input",{type:"number",step:"0.01",value:e.precio_unitario,onChange:e=>F(t,{precio_unitario:e.target.value})})}),(0,s.jsx)("td",{children:(0,s.jsx)("input",{type:"number",step:"0.01",value:e.precio_final,onChange:e=>F(t,{precio_final:e.target.value})})}),(0,s.jsx)("td",{children:(0,s.jsx)("input",{type:"number",value:e.subtotal,readOnly:!0})}),(0,s.jsx)("td",{children:(0,s.jsx)("button",{type:"button",className:"btn-delete",onClick:()=>(e=>{w(t=>t.filter((t,r)=>r!==e))})(t),children:"Quitar"})})]},"".concat(e.producto_id,"-").concat(t)))})]})})]})]})})]})}},218(e,t,r){r.d(t,{A:()=>i});var c=r(950);const i=()=>{const e=(0,c.useRef)(!0);return(0,c.useEffect)(()=>(e.current=!0,()=>{e.current=!1}),[]),e}}}]);